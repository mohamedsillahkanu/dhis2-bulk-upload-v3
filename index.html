<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHIS2 Dataset Upload - ICF-NMDR</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; padding: 0; background-color: #f0f4f8; font-family: 'Oswald', Arial, sans-serif; color: #000; font-weight: 500; min-height: 100vh; }

        /* Login Screen */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #004080 0%, #0066cc 100%); }
        .login-card { background: #fff; border-radius: 12px; padding: 40px; max-width: 450px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,.2); border: 4px double #004080; }
        .logo-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .logo-box { background: #f8f9fa; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid #004080; }
        .logo-box img { width: 100px; height: auto; border-radius: 6px; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: #004080; font-size: 22px; font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
        .login-header p { color: #666; font-size: 13px; }

        /* Form elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #004080; font-size: 13px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; color: #000; background: #fff; transition: all .3s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0,64,128,.1); }
        .form-input::placeholder { color: #999; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* Buttons */
        .btn-primary { width: 100%; padding: 14px 24px; background: #004080; color: #fff; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: .5px; font-family: 'Oswald', Arial, sans-serif; transition: all .3s; }
        .btn-primary:hover { background: #0056b3; border-color: #0056b3; }
        .btn-primary:disabled { background: #6c757d; border-color: #6c757d; cursor: wait; opacity: .9; }
        .btn-secondary { padding: 12px 20px; background: #fff; color: #004080; border: 2px solid #004080; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all .3s; }
        .btn-secondary:hover { background: #004080; color: #fff; }
        .btn-gold { padding: 14px 28px; background: #ffc107; color: #000; border: 2px solid #ffc107; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all .3s; }
        .btn-gold:hover { background: #e0a800; border-color: #e0a800; }
        .btn-success { padding: 14px 28px; background: #28a745; color: #fff; border: 2px solid #28a745; border-radius: 6px; font-size: 15px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: 'Oswald', Arial, sans-serif; transition: all .3s; }
        .btn-success:hover { background: #218838; border-color: #218838; }
        .btn-success:disabled { background: #6c757d; border-color: #6c757d; cursor: wait; }

        /* Main Content */
        .main-content { display: none; padding: 20px; }
        .main-content.active { display: block; }
        .page-container { width: 100%; max-width: 1400px; margin: 0 auto; }
        .page-header { background-color: #004080; color: #fff; padding: 25px 30px; text-align: center; margin-bottom: 15px; border-radius: 8px 8px 0 0; }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; }
        .page-header .logo-box { background: #fff; border: none; }
        .page-header h3 { margin: 12px 0 5px; font-size: 14px; font-weight: 700; letter-spacing: 1px; }
        .page-header .tagline { margin: 0; font-size: 10px; font-weight: 500; }
        .page-header h1 { margin: 20px 0 10px; font-size: 24px; font-weight: 700; letter-spacing: 1px; }
        .page-header .subtitle { font-size: 14px; font-weight: 500; }

        .content-card { border: 4px double #004080; border-radius: 12px; padding: 12px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,.1); margin-bottom: 15px; }
        .content-inner { padding: 25px; }

        .section-header { background: #004080; color: #fff; padding: 15px 20px; margin-bottom: 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; }
        .section-icon { background: #fff; color: #004080; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; flex-shrink: 0; }
        .section-title { font-size: 16px; font-weight: 700; letter-spacing: .5px; }

        /* Drop Zone */
        .drop-zone { border: 3px dashed #004080; border-radius: 12px; padding: 50px 30px; text-align: center; background: #f0f7ff; cursor: pointer; transition: all .3s; position: relative; }
        .drop-zone:hover, .drop-zone.dragover { background: #d9ecff; border-color: #0056b3; transform: scale(1.01); }
        .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .drop-zone-icon { font-size: 56px; margin-bottom: 15px; }
        .drop-zone-title { font-size: 20px; font-weight: 700; color: #004080; margin-bottom: 8px; }
        .drop-zone-sub { font-size: 13px; color: #666; }
        .file-info-badge { display: inline-flex; align-items: center; gap: 10px; background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 12px 20px; margin-top: 15px; font-size: 14px; font-weight: 600; color: #155724; }
        .file-info-badge .remove-file { background: #dc3545; color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; }

        /* Sheet Selector */
        .sheet-selector { background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px 20px; margin: 15px 0; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .sheet-selector label { font-weight: 700; color: #856404; white-space: nowrap; }
        .sheet-selector select { padding: 8px 15px; border: 2px solid #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 13px; min-width: 200px; }

        /* Load Datasets Button */
        .load-datasets-container { text-align: center; margin: 20px 0; }
        .load-datasets-btn { background: #004080; color: white; border: none; padding: 15px 40px; font-size: 18px; font-weight: 700; border-radius: 50px; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: all 0.3s; }
        .load-datasets-btn:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .load-datasets-btn:disabled { background: #6c757d; cursor: wait; transform: none; }

        /* Dataset Selector */
        .dataset-selector { background: #e7f3ff; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin: 20px 0; display: none; }
        .dataset-selector label { font-weight: 700; color: #004080; display: block; margin-bottom: 10px; }
        .dataset-selector select { width: 100%; padding: 12px; border: 2px solid #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 14px; }

        /* Configuration Panel */
        .config-panel { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .config-panel h3 { color: #004080; font-size: 15px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #004080; }

        /* Mapping Grid */
        .mapping-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .mapping-card { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; }
        .mapping-card.mapped { border-color: #28a745; background: #d4edda; }
        .mapping-card .excel-col { font-size: 13px; font-weight: 600; margin-bottom: 10px; padding: 6px 10px; background: #e9ecef; border-radius: 4px; word-break: break-word; }
        .mapping-card select { width: 100%; padding: 8px 10px; border: 2px solid #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 12px; }

        /* Preview Table */
        .preview-table-wrap { overflow-x: auto; max-height: 350px; overflow-y: auto; border: 2px solid #004080; border-radius: 8px; margin: 15px 0; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .preview-table th { background: #004080; color: #fff; padding: 10px 12px; text-align: left; position: sticky; top: 0; white-space: nowrap; font-weight: 600; }
        .preview-table td { padding: 8px 12px; border-bottom: 1px solid #e9ecef; white-space: nowrap; }

        /* Upload Summary */
        .upload-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .summary-card { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 15px; text-align: center; }
        .summary-card.highlight { border-color: #004080; background: #e7f3ff; }
        .summary-num { font-size: 32px; font-weight: 700; color: #004080; line-height: 1; }
        .summary-label { font-size: 12px; color: #666; margin-top: 5px; }

        /* Progress */
        .progress-section { display: none; background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .progress-section.active { display: block; }
        .progress-bar { height: 28px; background: #e9ecef; border-radius: 6px; overflow: hidden; border: 2px solid #004080; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #004080, #0066cc); transition: width .3s; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 700; }
        .log-container { margin-top: 15px; max-height: 220px; overflow-y: auto; background: #1a1a2e; border-radius: 6px; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; }
        .log-entry { padding: 3px 0; border-bottom: 1px solid #333; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }

        /* Notification */
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 8px; font-weight: 600; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,.2); min-width: 280px; text-align: center; }
        .notification.success { background: #d4edda; color: #155724; border: 2px solid #28a745; display: block; }
        .notification.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; display: block; }
        .notification.info { background: #e7f3ff; color: #004080; border: 2px solid #004080; display: block; }

        /* Footer */
        .page-footer { background-color: #004080; color: #fff; padding: 20px 30px; text-align: center; font-size: 13px; line-height: 1.7; font-weight: 500; border-radius: 0 0 8px 8px; }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
    <div class="login-card">
        <div class="logo-container">
            <div class="logo-box">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL Logo">
            </div>
        </div>
        <div class="login-header">
            <h1>ICF-NMDR DHIS2 UPLOAD</h1>
            <p>Dataset-Based Data Upload Tool</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label class="form-label">DHIS2 Instance URL</label>
                <input type="url" class="form-input" id="instanceUrl" value="https://icf-nmdr.onrender.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="username" value="admin" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="password" value="SajeedIslam@2025" required>
            </div>
            <button type="submit" class="btn-primary" id="loginBtn">Connect to DHIS2</button>
        </form>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content" id="mainContent">
    <div class="page-container">
        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL" style="width:100px;">
                </div>
            </div>
            <h3>Informatics Consultancy Firm - NMDR</h3>
            <p class="tagline"><em>National Malaria Data Repository</em></p>
            <h1>üì§ DATASET UPLOAD TOOL</h1>
            <p class="subtitle">Load Dataset ‚Üí Upload Excel ‚Üí Map Columns ‚Üí Upload to DHIS2</p>
        </div>

        <div class="content-card">
            <div class="content-inner">
                <!-- Step 1: Load Datasets Button -->
                <div class="load-datasets-container">
                    <button class="load-datasets-btn" id="loadDatasetsBtn" onclick="loadDatasets()">üì• LOAD DATASETS</button>
                </div>

                <!-- Dataset Selector (hidden initially) -->
                <div class="dataset-selector" id="datasetSelector">
                    <label>Select Dataset:</label>
                    <select id="datasetSelect" onchange="loadDatasetDataElements()">
                        <option value="">-- Select a dataset --</option>
                    </select>
                    <div id="datasetInfo" style="margin-top:10px; font-size:13px; color:#004080;"></div>
                </div>

                <!-- Upload Section (hidden initially) -->
                <div id="uploadSection" style="display:none;">
                    <div class="section-header" style="margin-top:30px;">
                        <span class="section-icon">2</span>
                        <span class="section-title">UPLOAD EXCEL FILE</span>
                    </div>

                    <div class="drop-zone" id="dropZone">
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
                        <div class="drop-zone-icon">üìä</div>
                        <div class="drop-zone-title">Drop your Excel file here</div>
                        <div class="drop-zone-sub">or click to browse</div>
                        <div id="fileBadge" style="display:none;">
                            <div class="file-info-badge">
                                <span id="fileNameLabel">filename.xlsx</span>
                                <button class="remove-file" onclick="removeFile(event)">√ó</button>
                            </div>
                        </div>
                    </div>

                    <div class="sheet-selector" id="sheetSelector" style="display:none;">
                        <label>Select Sheet:</label>
                        <select id="sheetSelect" onchange="loadSheet()"></select>
                        <span id="sheetInfo"></span>
                    </div>
                </div>

                <!-- Configuration Section (hidden initially) -->
                <div id="configSection" style="display:none;">
                    <div class="section-header" style="margin-top:30px;">
                        <span class="section-icon">3</span>
                        <span class="section-title">CONFIGURE COLUMNS</span>
                    </div>

                    <div class="config-panel">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Organisation Unit Column</label>
                                <select class="form-select" id="orgUnitColSelect" onchange="updateMappingUI()">
                                    <option value="">-- Select column --</option>
                                </select>
                                <div style="margin-top:10px;">
                                    <label class="form-label" style="font-size:11px;">Org Unit Level</label>
                                    <select class="form-select" id="orgUnitLevel">
                                        <option value="1">Level 1 (National)</option>
                                        <option value="2">Level 2 (District)</option>
                                        <option value="3" selected>Level 3 (Facility)</option>
                                        <option value="4">Level 4 (Ward)</option>
                                        <option value="">All Levels</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Period Column</label>
                                <select class="form-select" id="periodColSelect" onchange="updateMappingUI()">
                                    <option value="">-- Select column --</option>
                                </select>
                                <div style="margin-top:10px;">
                                    <label class="form-label" style="font-size:11px;">Period Format</label>
                                    <select class="form-select" id="periodFormat">
                                        <option value="YYYYMM" selected>YYYYMM (e.g., 202301)</option>
                                        <option value="YYYY-MM">YYYY-MM (converts to YYYYMM)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mapping Section (hidden initially) -->
                <div id="mappingSection" style="display:none;">
                    <div class="section-header" style="margin-top:30px; background:#28a745;">
                        <span class="section-icon">4</span>
                        <span class="section-title">MAP COLUMNS TO DATA ELEMENTS</span>
                    </div>

                    <div style="margin:20px 0;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                            <h3 style="color:#004080;">Data Element Mappings</h3>
                            <span id="mappedCount" style="background:#28a745; color:#fff; padding:4px 12px; border-radius:20px;">0 mapped</span>
                        </div>
                        <div class="mapping-grid" id="mappingGrid"></div>
                    </div>

                    <button class="btn-gold" onclick="prepareUpload()" style="width:100%;">Prepare Upload Data</button>
                </div>

                <!-- Review Section (hidden initially) -->
                <div id="reviewSection" style="display:none;">
                    <div class="section-header" style="margin-top:30px;">
                        <span class="section-icon">5</span>
                        <span class="section-title">REVIEW & UPLOAD</span>
                    </div>

                    <div class="upload-summary" id="summaryStats"></div>

                    <div style="margin:20px 0;">
                        <h3 style="color:#004080;">Organisation Unit Matching</h3>
                        <div class="preview-table-wrap" id="orgMatchResults"></div>
                    </div>

                    <div style="margin:20px 0;">
                        <h3 style="color:#004080;">Data Preview</h3>
                        <div class="preview-table-wrap">
                            <table class="preview-table" id="previewTable"></table>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Import Strategy</label>
                            <select class="form-select" id="importStrategy">
                                <option value="CREATE_AND_UPDATE">CREATE_AND_UPDATE</option>
                                <option value="CREATE">CREATE</option>
                                <option value="UPDATE">UPDATE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Batch Size</label>
                            <select class="form-select" id="batchSize">
                                <option value="250">250 rows</option>
                                <option value="500">500 rows</option>
                                <option value="1000">1000 rows</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin:15px 0;">
                        <input type="checkbox" id="dryRun"> <label for="dryRun">Dry Run (test only)</label>
                    </div>

                    <div class="progress-section" id="progressSection">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <div class="log-container" id="logContainer"></div>
                    </div>

                    <button class="btn-success" id="uploadBtn" onclick="startUpload()" style="width:100%; margin-top:20px;">üöÄ UPLOAD TO DHIS2</button>
                </div>
            </div>
        </div>

        <div class="page-footer">
            <p>Informatics Consultancy Firm - National Malaria Data Repository</p>
            <p>¬© 2025 ICF-NMDR</p>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
// Configuration
const PROXY = 'https://script.google.com/macros/s/AKfycbyRXc68PYSmDSCYPakAS8Gc9R00kRjmsMYoDujPYMItyquXfwMAJUtRqXLiDlNWbSfDQQ/exec';
let state = { config: null };

// Data storage
let workbook = null;
let excelData = [];
let excelHeaders = [];
let dhis2OrgUnits = [];
let datasets = [];
let currentDataset = null;
let datasetDataElements = [];
let orgUnitMap = new Map();
let uploadPayload = [];
let columnMappings = {};

// Utility Functions
function showNotification(msg, type) {
    const n = document.getElementById('notification');
    n.textContent = msg;
    n.className = `notification ${type}`;
    setTimeout(() => n.className = 'notification', 4000);
}

function log(msg, type) {
    const c = document.getElementById('logContainer');
    const e = document.createElement('div');
    e.className = `log-entry ${type}`;
    e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    c.appendChild(e);
    c.scrollTop = c.scrollHeight;
}

function setProgress(pct) {
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressFill').textContent = pct + '%';
}

function escapeHtml(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Proxy Request - EXACT same as working code
async function makeProxyRequest(targetUrl, options = {}) {
    let proxyUrl = `${PROXY}?url=${encodeURIComponent(targetUrl)}`;
    if (options.headers && options.headers.Authorization) {
        proxyUrl += `&Authorization=${encodeURIComponent(options.headers.Authorization)}`;
    }
    return fetch(proxyUrl, { method: options.method || 'GET', body: options.body });
}

async function fetchWithAuth(url, options = {}) {
    if (!state.config) throw new Error('Not authenticated');
    const authHeader = 'Basic ' + btoa(`${state.config.username}:${state.config.password}`);
    return makeProxyRequest(url, { ...options, headers: { 'Authorization': authHeader, 'Content-Type': 'application/json', ...options.headers } });
}

// Login - EXACT same as working code
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const instanceUrl = document.getElementById('instanceUrl').value.trim().replace(/\/$/, '');
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    const submitBtn = e.target.querySelector('.btn-primary');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Connecting...';
    
    try {
        const testUrl = `${instanceUrl}/api/me`;
        const authHeader = 'Basic ' + btoa(`${username}:${password}`);
        
        const response = await makeProxyRequest(testUrl, { 
            method: 'GET', 
            headers: { 'Authorization': authHeader } 
        });
        
        if (response.ok) {
            const userData = await response.json();
            state.config = { instanceUrl, username, password };
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('active');
            showNotification(`Connected! Welcome ${userData.firstName || ''}`, 'success');
            
            // Load org units
            await loadOrgUnits();
        } else {
            showNotification(`Login failed (${response.status})`, 'error');
        }
    } catch (error) {
        showNotification(`Connection failed: ${error.message}`, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Connect to DHIS2';
    }
});

// Load Organisation Units
async function loadOrgUnits() {
    try {
        const ouRes = await fetchWithAuth(`${state.config.instanceUrl}/api/organisationUnits.json?fields=id,name,displayName,code,level&paging=false`);
        const ouData = await ouRes.json();
        dhis2OrgUnits = ouData.organisationUnits || [];
        log(`Loaded ${dhis2OrgUnits.length} organisation units`, 'success');
    } catch (err) {
        showNotification(`Error loading org units: ${err.message}`, 'error');
    }
}

// Load Datasets - FIXED: Using EXACT same pattern as working code
async function loadDatasets() {
    const btn = document.getElementById('loadDatasetsBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ LOADING...';
    
    try {
        log('Fetching datasets from DHIS2...', 'info');
        showNotification('Loading datasets...', 'info');
        
        // EXACT same URL pattern as working code
        const url = `${state.config.instanceUrl}/api/dataSets.json?fields=id,displayName,name,periodType,dataSetElements[dataElement[id,displayName,name]]&paging=false`;
        const response = await fetchWithAuth(url);
        
        if (!response.ok) throw new Error(`Failed to fetch datasets: ${response.status}`);
        
        const data = await response.json();
        
        // EXACT same response structure as working code
        datasets = data.dataSets || [];
        
        log(`Loaded ${datasets.length} datasets`, 'success');
        
        // Populate dataset selector
        const select = document.getElementById('datasetSelect');
        select.innerHTML = '<option value="">-- Select a dataset --</option>' + 
            datasets.map(ds => `<option value="${ds.id}">${ds.displayName || ds.name}</option>`).join('');
        
        // Show dataset selector and upload section
        document.getElementById('datasetSelector').style.display = 'block';
        document.getElementById('uploadSection').style.display = 'block';
        
        document.getElementById('datasetInfo').innerHTML = `‚úÖ Loaded ${datasets.length} datasets`;
        
        showNotification(`Loaded ${datasets.length} datasets`, 'success');
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
        showNotification(`Failed to load datasets: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'üì• LOAD DATASETS';
    }
}

// Load Data Elements for Selected Dataset
async function loadDatasetDataElements() {
    const datasetId = document.getElementById('datasetSelect').value;
    if (!datasetId) return;
    
    try {
        currentDataset = datasets.find(d => d.id === datasetId);
        document.getElementById('datasetInfo').innerHTML = `üìä Selected: ${currentDataset?.displayName || currentDataset?.name} - Loading...`;
        
        // Fetch dataset details
        const dsRes = await fetchWithAuth(`${state.config.instanceUrl}/api/dataSets/${datasetId}.json?fields=id,displayName,dataSetElements[dataElement[id,displayName,name]]`);
        const dsData = await dsRes.json();
        
        // Extract data elements
        datasetDataElements = (dsData.dataSetElements || []).map(dse => dse.dataElement).filter(Boolean);
        
        document.getElementById('datasetInfo').innerHTML = `‚úÖ Selected: ${currentDataset?.displayName || currentDataset?.name} (${datasetDataElements.length} data elements)`;
        
        log(`Loaded ${datasetDataElements.length} data elements`, 'success');
        
        // Show config section if file is loaded
        if (excelHeaders.length > 0) {
            document.getElementById('configSection').style.display = 'block';
            populateColumnDropdowns();
        }
    } catch (err) {
        showNotification(`Error: ${err.message}`, 'error');
    }
}

// File Handling
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) processFile(file);
}

function removeFile(e) {
    e.stopPropagation();
    workbook = null;
    excelData = [];
    excelHeaders = [];
    columnMappings = {};
    document.getElementById('fileBadge').style.display = 'none';
    document.getElementById('sheetSelector').style.display = 'none';
    document.getElementById('configSection').style.display = 'none';
    document.getElementById('mappingSection').style.display = 'none';
    document.getElementById('reviewSection').style.display = 'none';
    document.getElementById('fileInput').value = '';
    showNotification('File removed', 'info');
}

function processFile(file) {
    document.getElementById('fileNameLabel').textContent = file.name;
    document.getElementById('fileBadge').style.display = 'block';

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            workbook = XLSX.read(data, { type: 'array' });
            populateSheetSelector();
            loadSheet();
            showNotification(`File loaded: ${file.name}`, 'success');
        } catch (err) {
            showNotification(`Error: ${err.message}`, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

function populateSheetSelector() {
    const sel = document.getElementById('sheetSelect');
    sel.innerHTML = workbook.SheetNames.map((n, i) => `<option value="${i}">${n}</option>`).join('');
    document.getElementById('sheetSelector').style.display = 'flex';
}

function loadSheet() {
    const idx = parseInt(document.getElementById('sheetSelect').value) || 0;
    const sheetName = workbook.SheetNames[idx];
    const sheet = workbook.Sheets[sheetName];
    
    const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
    if (rawData.length < 1) return;
    
    excelHeaders = rawData[0].map(h => String(h).trim());
    excelData = rawData.slice(1).filter(row => row.some(c => c !== ''));
    
    document.getElementById('sheetInfo').textContent = `${excelData.length} rows, ${excelHeaders.length} columns`;
    
    if (currentDataset && datasetDataElements.length > 0) {
        document.getElementById('configSection').style.display = 'block';
        populateColumnDropdowns();
    }
}

function populateColumnDropdowns() {
    const options = excelHeaders.map((h, i) => `<option value="${i}">${h}</option>`).join('');
    document.getElementById('orgUnitColSelect').innerHTML = '<option value="">-- Select --</option>' + options;
    document.getElementById('periodColSelect').innerHTML = '<option value="">-- Select --</option>' + options;
}

function updateMappingUI() {
    const ouCol = document.getElementById('orgUnitColSelect').value;
    const perCol = document.getElementById('periodColSelect').value;
    
    if (ouCol && perCol) {
        populateMappingUI();
        document.getElementById('mappingSection').style.display = 'block';
    }
}

function populateMappingUI() {
    const grid = document.getElementById('mappingGrid');
    grid.innerHTML = '';
    columnMappings = {};
    
    excelHeaders.forEach((header, idx) => {
        if (idx === parseInt(document.getElementById('orgUnitColSelect').value) || 
            idx === parseInt(document.getElementById('periodColSelect').value)) return;
        
        const match = findDataElementMatch(header);
        const select = document.createElement('select');
        select.id = `map-${idx}`;
        select.style.width = '100%';
        select.style.padding = '8px';
        select.style.border = '2px solid #004080';
        select.style.borderRadius = '4px';
        
        let options = '<option value="">-- Skip --</option>';
        datasetDataElements.forEach(de => {
            const name = de.displayName || de.name;
            options += `<option value="${de.id}" ${match?.id === de.id ? 'selected' : ''}>${name}</option>`;
        });
        select.innerHTML = options;
        
        if (match) {
            columnMappings[idx] = { deId: match.id, deName: match.displayName || match.name };
        }
        
        select.onchange = () => {
            if (select.value) {
                const de = datasetDataElements.find(d => d.id === select.value);
                columnMappings[idx] = { deId: select.value, deName: de?.displayName || de?.name || '' };
            } else {
                delete columnMappings[idx];
            }
            document.getElementById('mappedCount').textContent = `${Object.keys(columnMappings).length} mapped`;
        };
        
        const card = document.createElement('div');
        card.className = `mapping-card ${match ? 'mapped' : ''}`;
        card.innerHTML = `<div class="excel-col">${escapeHtml(header)}</div>`;
        card.appendChild(select);
        grid.appendChild(card);
    });
    
    document.getElementById('mappedCount').textContent = `${Object.keys(columnMappings).length} mapped`;
}

function findDataElementMatch(header) {
    const h = header.toLowerCase().trim();
    return datasetDataElements.find(de => 
        (de.displayName || de.name || '').toLowerCase().trim() === h
    );
}

function parsePeriod(val, format) {
    if (!val) return null;
    val = val.toString().trim();
    
    if (format === 'YYYYMM' && /^\d{6}$/.test(val)) return val;
    if (format === 'YYYY-MM' && /^\d{4}-\d{2}$/.test(val)) return val.replace('-', '');
    return null;
}

async function prepareUpload() {
    const ouCol = parseInt(document.getElementById('orgUnitColSelect').value);
    const perCol = parseInt(document.getElementById('periodColSelect').value);
    const orgLevel = document.getElementById('orgUnitLevel').value;
    const periodFmt = document.getElementById('periodFormat').value;
    
    if (isNaN(ouCol) || isNaN(perCol)) {
        showNotification('Select Org Unit and Period columns', 'error');
        return;
    }
    
    // Match org units
    const uniqueOUs = [...new Set(excelData.map(row => String(row[ouCol] || '').trim()))].filter(Boolean);
    orgUnitMap.clear();
    
    let matched = 0, unmatched = 0;
    uniqueOUs.forEach(val => {
        const normalized = val.toLowerCase().trim();
        const match = dhis2OrgUnits.find(ou => 
            (ou.displayName || ou.name || '').toLowerCase().trim() === normalized
        );
        if (match) {
            orgUnitMap.set(val, match.id);
            matched++;
        } else {
            orgUnitMap.set(val, null);
            unmatched++;
        }
    });
    
    // Build payload
    uploadPayload = [];
    excelData.forEach(row => {
        const ouVal = String(row[ouCol] || '').trim();
        const perVal = String(row[perCol] || '').trim();
        const ouId = orgUnitMap.get(ouVal);
        const period = parsePeriod(perVal, periodFmt);
        
        if (!ouId || !period) return;
        
        Object.entries(columnMappings).forEach(([colIdx, mapping]) => {
            const value = row[parseInt(colIdx)];
            if (value !== '' && value !== null) {
                uploadPayload.push({
                    dataElement: mapping.deId,
                    period: period,
                    orgUnit: ouId,
                    value: String(value)
                });
            }
        });
    });
    
    // Show results
    let matchHtml = '';
    uniqueOUs.forEach(val => {
        const id = orgUnitMap.get(val);
        if (id) {
            const ou = dhis2OrgUnits.find(o => o.id === id);
            matchHtml += `<div style="background:#d4edda; padding:8px; margin:2px;">‚úì ${escapeHtml(val)} ‚Üí ${escapeHtml(ou?.displayName || '')}</div>`;
        } else {
            matchHtml += `<div style="background:#f8d7da; padding:8px; margin:2px;">‚úó ${escapeHtml(val)} ‚Üí Not found</div>`;
        }
    });
    document.getElementById('orgMatchResults').innerHTML = matchHtml || '<div>No org units found</div>';
    
    // Summary
    document.getElementById('summaryStats').innerHTML = `
        <div class="summary-card highlight"><div class="summary-num">${uploadPayload.length}</div><div class="summary-label">Values</div></div>
        <div class="summary-card"><div class="summary-num">${matched}</div><div class="summary-label">Matched OUs</div></div>
        <div class="summary-card"><div class="summary-num">${unmatched}</div><div class="summary-label">Unmatched OUs</div></div>
    `;
    
    // Preview
    let previewHtml = '<thead><tr><th>#</th><th>Org Unit</th><th>Period</th>';
    Object.values(columnMappings).forEach(m => previewHtml += `<th>${escapeHtml(m.deName)}</th>`);
    previewHtml += '</tr></thead><tbody>';
    
    excelData.slice(0, 20).forEach((row, i) => {
        previewHtml += `<tr><td>${i+1}</td>`;
        previewHtml += `<td>${escapeHtml(String(row[ouCol] || ''))}</td>`;
        previewHtml += `<td>${escapeHtml(String(row[perCol] || ''))}</td>`;
        Object.keys(columnMappings).forEach(colIdx => previewHtml += `<td>${escapeHtml(String(row[parseInt(colIdx)] || ''))}</td>`);
        previewHtml += '</tr>';
    });
    previewHtml += '</tbody>';
    document.getElementById('previewTable').innerHTML = previewHtml;
    
    document.getElementById('reviewSection').style.display = 'block';
}

async function startUpload() {
    if (uploadPayload.length === 0) {
        showNotification('Nothing to upload', 'error');
        return;
    }
    
    const btn = document.getElementById('uploadBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Uploading...';
    
    document.getElementById('progressSection').classList.add('active');
    setProgress(0);
    
    const strategy = document.getElementById('importStrategy').value;
    const batchSize = parseInt(document.getElementById('batchSize').value);
    const dryRun = document.getElementById('dryRun').checked;
    
    const totalBatches = Math.ceil(uploadPayload.length / batchSize);
    let imported = 0, updated = 0, ignored = 0;
    
    for (let b = 0; b < totalBatches; b++) {
        const batch = uploadPayload.slice(b * batchSize, (b + 1) * batchSize);
        setProgress(Math.round((b / totalBatches) * 90));
        
        try {
            let url = `${state.config.instanceUrl}/api/dataValueSets?importStrategy=${strategy}&dryRun=${dryRun}`;
            const auth = 'Basic ' + btoa(`${state.config.username}:${state.config.password}`);
            let proxyUrl = `${PROXY}?url=${encodeURIComponent(url)}&Authorization=${encodeURIComponent(auth)}`;
            
            const res = await fetch(proxyUrl, { 
                method: 'POST', 
                body: JSON.stringify({ dataValues: batch }), 
                headers: { 'Content-Type': 'application/json' } 
            });
            
            if (res.ok) {
                const result = await res.json();
                const imp = result.importCount || {};
                imported += imp.imported || 0;
                updated += imp.updated || 0;
                ignored += imp.ignored || 0;
            }
        } catch (err) {
            log(`Batch ${b+1} error: ${err.message}`, 'error');
        }
    }
    
    setProgress(100);
    log(`Upload complete! Imported: ${imported}, Updated: ${updated}, Ignored: ${ignored}`, 'success');
    showNotification('Upload complete!', 'success');
    
    btn.disabled = false;
    btn.textContent = 'üöÄ UPLOAD TO DHIS2';
}
</script>
</body>
</html>
