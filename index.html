<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHIS2 Bulk Dataset Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f0f4f8; font-family: 'Oswald', Arial, sans-serif; color: #000; font-weight: 500; min-height: 100vh; }

        /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #004080 0%, #0066cc 100%); }
        .login-card { background: #fff; border-radius: 12px; padding: 40px; max-width: 480px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,.25); border: 4px double #004080; }
        .logo-container { display: flex; justify-content: center; margin-bottom: 25px; }
        .logo-box { background: #f8f9fa; border-radius: 8px; padding: 10px; border: 2px solid #004080; }
        .logo-box img { width: 100px; height: auto; border-radius: 6px; display: block; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: #004080; font-size: 22px; font-weight: 700; margin-bottom: 6px; letter-spacing: 1px; }
        .login-header p { color: #666; font-size: 13px; }

        /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; color: #004080; font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
        .form-input, .form-select { width: 100%; padding: 11px 14px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; color: #000; background: #fff; transition: all .2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0,64,128,.12); }
        .form-input::placeholder { color: #bbb; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn-primary { width: 100%; padding: 14px; background: #004080; color: #fff; border: 2px solid #004080; border-radius: 6px; font-size: 15px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: .5px; font-family: 'Oswald', Arial, sans-serif; transition: all .2s; }
        .btn-primary:hover { background: #0056b3; }
        .btn-primary:disabled { background: #6c757d; border-color: #6c757d; cursor: wait; }
        .btn-blue { padding: 11px 22px; background: #004080; color: #fff; border: 2px solid #004080; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; transition: all .2s; }
        .btn-blue:hover { background: #0056b3; }
        .btn-blue:disabled { background: #6c757d; border-color: #6c757d; cursor: wait; }
        .btn-gold { padding: 13px 30px; background: #ffc107; color: #000; border: 2px solid #ffc107; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; transition: all .2s; }
        .btn-gold:hover { background: #e0a800; }
        .btn-gold:disabled { background: #e9ecef; color: #888; border-color: #ccc; cursor: wait; }
        .btn-green { padding: 14px 36px; background: #28a745; color: #fff; border: 2px solid #28a745; border-radius: 6px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; transition: all .2s; }
        .btn-green:hover { background: #218838; }
        .btn-green:disabled { background: #6c757d; border-color: #6c757d; cursor: wait; }
        .btn-outline { padding: 11px 22px; background: #fff; color: #004080; border: 2px solid #004080; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; transition: all .2s; }
        .btn-outline:hover { background: #004080; color: #fff; }
        .btn-outline-red { padding: 11px 22px; background: #fff; color: #dc3545; border: 2px solid #dc3545; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; font-family: 'Oswald', Arial, sans-serif; transition: all .2s; }
        .btn-outline-red:hover { background: #dc3545; color: #fff; }

        /* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
        .main-content { display: none; padding: 20px; }
        .main-content.active { display: block; }
        .page-container { max-width: 1300px; margin: 0 auto; }

        .page-header { background: #004080; color: #fff; padding: 25px 30px; text-align: center; border-radius: 8px 8px 0 0; margin-bottom: 0; }
        .logo-row { display: flex; justify-content: center; margin-bottom: 12px; }
        .page-header .logo-box { background: #fff; border: none; }
        .page-header h3 { font-size: 13px; font-weight: 700; letter-spacing: 1px; margin-bottom: 4px; }
        .page-header .tagline { font-size: 10px; margin-bottom: 12px; }
        .page-header h1 { font-size: 22px; font-weight: 700; letter-spacing: 1px; margin-bottom: 6px; }
        .page-header .subtitle { font-size: 13px; }

        .content-card { border: 4px double #004080; border-top: none; border-radius: 0 0 12px 12px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,.1); margin-bottom: 15px; }
        .content-inner { padding: 28px; }

        .section-header { background: #004080; color: #fff; padding: 13px 18px; margin-bottom: 18px; border-radius: 6px; display: flex; align-items: center; gap: 12px; }
        .section-icon { background: #fff; color: #004080; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 700; flex-shrink: 0; }
        .section-title { font-size: 15px; font-weight: 700; letter-spacing: .5px; }

        /* ‚îÄ‚îÄ Step Tabs ‚îÄ‚îÄ */
        .step-tabs { display: flex; gap: 4px; margin-bottom: 22px; flex-wrap: wrap; }
        .step-tab { padding: 10px 18px; background: #e9ecef; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all .2s; color: #666; display: flex; align-items: center; gap: 7px; font-family: 'Oswald', Arial, sans-serif; }
        .step-tab.active { background: #004080; color: #fff; border-color: #004080; }
        .step-tab.done { background: #d4edda; color: #155724; border-color: #28a745; }
        .step-tab .sn { width: 20px; height: 20px; border-radius: 50%; background: rgba(0,0,0,.15); display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; }
        .step-tab.done .sn { background: #28a745; color: #fff; }
        .step-panel { display: none; }
        .step-panel.active { display: block; }

        /* ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ */
        .drop-zone { border: 3px dashed #004080; border-radius: 10px; padding: 45px 25px; text-align: center; background: #f0f7ff; cursor: pointer; transition: all .25s; position: relative; }
        .drop-zone:hover, .drop-zone.over { background: #d9ecff; border-color: #0056b3; }
        .drop-zone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .dz-icon { font-size: 52px; margin-bottom: 12px; }
        .dz-title { font-size: 18px; font-weight: 700; color: #004080; margin-bottom: 6px; }
        .dz-sub { font-size: 12px; color: #777; }
        .file-badge { display: inline-flex; align-items: center; gap: 10px; background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 10px 18px; margin-top: 14px; font-size: 13px; font-weight: 600; color: #155724; }
        .remove-file-btn { background: #dc3545; color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* ‚îÄ‚îÄ Dataset Selector ‚îÄ‚îÄ */
        .dataset-card { background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 18px; margin-bottom: 16px; }
        .dataset-card label { display: block; color: #004080; font-size: 13px; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
        .dataset-card select { width: 100%; padding: 12px 14px; border: 2px solid #004080; border-radius: 6px; font-size: 14px; font-family: 'Oswald', Arial, sans-serif; font-weight: 500; }
        .dataset-info { background: #e7f3ff; border: 1px solid #004080; border-radius: 6px; padding: 12px 15px; margin-top: 12px; font-size: 13px; line-height: 1.7; }
        .dataset-info strong { color: #004080; }

        /* ‚îÄ‚îÄ Column Mapping ‚îÄ‚îÄ */
        .map-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .map-table th { background: #004080; color: #fff; padding: 10px 14px; text-align: left; font-weight: 600; }
        .map-table td { padding: 8px 12px; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
        .map-table tr:nth-child(even) td { background: #f8f9fa; }
        .map-table tr:hover td { background: #e7f3ff; }
        .map-table select { width: 100%; padding: 7px 10px; border: 2px solid #004080; border-radius: 4px; font-family: 'Oswald', Arial, sans-serif; font-size: 12px; }
        .auto-badge { background: #28a745; color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 10px; white-space: nowrap; }
        .skip-badge { background: #aaa; color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 10px; }
        .mapped-badge { background: #004080; color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 10px; }

        /* ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ */
        .stat-row { display: flex; gap: 12px; flex-wrap: wrap; margin: 16px 0; }
        .stat-card { flex: 1; min-width: 130px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 14px; text-align: center; }
        .stat-card.blue { border-color: #004080; background: #e7f3ff; }
        .stat-card.green { border-color: #28a745; background: #d4edda; }
        .stat-card.red { border-color: #dc3545; background: #f8d7da; }
        .stat-card.gold { border-color: #ffc107; background: #fff3cd; }
        .stat-num { font-size: 30px; font-weight: 700; color: #004080; line-height: 1; }
        .stat-card.green .stat-num { color: #155724; }
        .stat-card.red .stat-num { color: #721c24; }
        .stat-card.gold .stat-num { color: #856404; }
        .stat-label { font-size: 11px; color: #666; margin-top: 5px; text-transform: uppercase; letter-spacing: .4px; }

        /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
        .progress-section { display: none; background: #f8f9fa; border: 2px solid #004080; border-radius: 8px; padding: 18px; margin: 18px 0; }
        .progress-section.active { display: block; }
        .progress-bar { height: 26px; background: #e9ecef; border-radius: 6px; overflow: hidden; border: 2px solid #004080; margin: 8px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #004080 0%, #0066cc 100%); transition: width .3s; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 700; min-width: 35px; }
        .log-box { margin-top: 12px; max-height: 220px; overflow-y: auto; background: #1a1a2e; border-radius: 6px; padding: 12px 14px; font-family: 'Courier New', monospace; font-size: 12px; }
        .log-entry { padding: 3px 0; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }

        /* ‚îÄ‚îÄ Info Boxes ‚îÄ‚îÄ */
        .info-box { padding: 11px 16px; border-radius: 6px; margin: 10px 0; font-size: 13px; line-height: 1.6; }
        .info-box.blue { background: #e7f3ff; border: 2px solid #004080; color: #004080; }
        .info-box.green { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .info-box.yellow { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        .info-box.red { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }

        /* ‚îÄ‚îÄ Preview Table ‚îÄ‚îÄ */
        .preview-wrap { overflow-x: auto; max-height: 320px; overflow-y: auto; border: 2px solid #004080; border-radius: 8px; margin: 14px 0; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .preview-table th { background: #004080; color: #fff; padding: 9px 12px; text-align: left; position: sticky; top: 0; white-space: nowrap; }
        .preview-table td { padding: 7px 12px; border-bottom: 1px solid #e9ecef; white-space: nowrap; }
        .preview-table tr:nth-child(even) td { background: #f8f9fa; }
        .preview-table tr:hover td { background: #e7f3ff; }
        .preview-table .v-ok { color: #155724; font-weight: 600; }
        .preview-table .v-empty { color: #ccc; }

        /* ‚îÄ‚îÄ Notification ‚îÄ‚îÄ */
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 13px 28px; border-radius: 8px; font-weight: 600; z-index: 3000; display: none; box-shadow: 0 4px 14px rgba(0,0,0,.22); min-width: 260px; text-align: center; font-size: 14px; }
        .notification.success { background: #d4edda; color: #155724; border: 2px solid #28a745; display: block; }
        .notification.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; display: block; }
        .notification.info { background: #e7f3ff; color: #004080; border: 2px solid #004080; display: block; }
        .notification.warning { background: #fff3cd; color: #856404; border: 2px solid #ffc107; display: block; }

        /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
        .page-footer { background: #004080; color: #fff; padding: 18px; text-align: center; font-size: 12px; line-height: 1.8; border-radius: 0 0 8px 8px; }

        /* ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ */
        .toggle-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
        .toggle-row input[type=checkbox] { width: 18px; height: 18px; accent-color: #004080; cursor: pointer; }
        .toggle-row label { font-size: 13px; cursor: pointer; }

        ::-webkit-scrollbar { width: 7px; height: 7px; }
        ::-webkit-scrollbar-thumb { background: #004080; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f0f4f8; }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .stat-row { gap: 8px; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="login-screen" id="loginScreen">
    <div class="login-card">
        <div class="logo-container">
            <div class="logo-box">
                <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
            </div>
        </div>
        <div class="login-header">
            <h1>DHIS2 BULK DATASET UPLOAD</h1>
            <p>Upload Excel data directly into any DHIS2 dataset</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label class="form-label">DHIS2 Instance URL</label>
                <input type="url" class="form-input" id="instanceUrl" placeholder="https://your-dhis2.org/instance" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
            </div>
            <button type="submit" class="btn-primary" id="loginBtn">üîó Connect to DHIS2</button>
        </form>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main-content" id="mainContent">
    <div class="page-container">

        <div class="page-header">
            <div class="logo-row">
                <div class="logo-box">
                    <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" style="width:90px;">
                </div>
            </div>
            <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
            <p class="tagline"><em>Driving Data-Driven Solutions for Health and Development</em></p>
            <h1>üì§ DHIS2 BULK DATASET UPLOAD</h1>
            <p class="subtitle">Map Excel columns ‚Üí DHIS2 Data Elements &amp; Upload in Bulk</p>
        </div>

        <div class="content-card">
            <div class="content-inner">

                <!-- Step Tabs -->
                <div class="step-tabs">
                    <div class="step-tab active" id="tab-1" onclick="goStep(1)"><span class="sn">1</span>Select Dataset</div>
                    <div class="step-tab" id="tab-2" onclick="goStep(2)"><span class="sn">2</span>Upload Excel</div>
                    <div class="step-tab" id="tab-3" onclick="goStep(3)"><span class="sn">3</span>Map Columns</div>
                    <div class="step-tab" id="tab-4" onclick="goStep(4)"><span class="sn">4</span>Preview</div>
                    <div class="step-tab" id="tab-5" onclick="goStep(5)"><span class="sn">5</span>Upload</div>
                </div>

                <!-- ‚îÄ‚îÄ STEP 1: Dataset ‚îÄ‚îÄ -->
                <div class="step-panel active" id="panel-1">
                    <div class="section-header">
                        <span class="section-icon">1</span>
                        <span class="section-title">SELECT TARGET DATASET</span>
                    </div>

                    <div class="info-box blue">
                        Choose the <strong>DHIS2 dataset</strong> where your Excel data will be uploaded.
                        All data elements belonging to that dataset will be available for column mapping.
                    </div>

                    <div style="margin-bottom:16px;">
                        <button class="btn-blue" id="loadDatasetsBtn" onclick="loadDatasets()">üîÑ Load All Datasets</button>
                        <span id="dsLoadStatus" style="margin-left:12px;font-size:13px;color:#666;"></span>
                    </div>

                    <div class="dataset-card">
                        <label>Target Dataset</label>
                        <select id="datasetSelect" onchange="onDatasetChange()">
                            <option value="">-- Load datasets first --</option>
                        </select>
                        <div id="datasetInfo" style="display:none;" class="dataset-info"></div>
                    </div>

                    <!-- Org Unit Level -->
                    <div class="dataset-card" style="margin-top:12px;">
                        <label>Organisation Unit Level for Upload</label>
                        <select id="ouLevelSelect" onchange="onOuLevelChange()">
                            <option value="">-- Load datasets first --</option>
                        </select>
                        <div class="info-box yellow" style="margin-top:10px;">
                            <strong>Note:</strong> Your Excel file must contain the <strong>DHIS2 Organisation Unit ID</strong>
                            (or Name) for the level you choose. The tool will use that column directly ‚Äî no tree selection needed.
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn-gold" id="step1Next" onclick="goStep(2)" disabled style="padding:13px 36px;">
                            Next: Upload Excel ‚Üí
                        </button>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ STEP 2: Excel ‚îÄ‚îÄ -->
                <div class="step-panel" id="panel-2">
                    <div class="section-header">
                        <span class="section-icon">2</span>
                        <span class="section-title">UPLOAD YOUR EXCEL FILE</span>
                    </div>

                    <div class="info-box blue">
                        Upload an Excel file (<strong>.xlsx / .xls / .csv</strong>). Your file must have at minimum:<br>
                        ‚Ä¢ A column for <strong>Organisation Unit</strong> (UID or name at the selected level)<br>
                        ‚Ä¢ A column for <strong>Period</strong> (e.g. 202301 for Jan 2023)<br>
                        ‚Ä¢ One or more columns for <strong>Data Element values</strong> (column headers will be matched to the dataset)
                    </div>

                    <div class="drop-zone" id="dropZone">
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFile(event)">
                        <div class="dz-icon">üìä</div>
                        <div class="dz-title">Drop Excel file here or click to browse</div>
                        <div class="dz-sub">.xlsx ¬∑ .xls ¬∑ .csv &nbsp;|&nbsp; Any size</div>
                        <div id="fileBadge" style="display:none;">
                            <div class="file-badge">
                                <span id="fileNameLbl"></span>
                                <button class="remove-file-btn" onclick="clearFile(event)">√ó</button>
                            </div>
                        </div>
                    </div>

                    <!-- Sheet + row settings -->
                    <div id="sheetRow" style="display:none;margin-top:14px;">
                        <div class="form-row" style="max-width:600px;">
                            <div class="form-group">
                                <label class="form-label">Sheet</label>
                                <select class="form-select" id="sheetSel" onchange="reloadSheet()"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Header Row #</label>
                                <input type="number" class="form-input" id="headerRow" value="1" min="1" max="30" onchange="reloadSheet()">
                            </div>
                        </div>
                        <div id="rawInfo" style="font-size:13px;color:#666;margin-bottom:10px;"></div>
                        <!-- Raw preview -->
                        <div class="preview-wrap" style="max-height:200px;">
                            <table class="preview-table" id="rawTable"></table>
                        </div>
                    </div>

                    <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;">
                        <button class="btn-outline" onclick="goStep(1)">‚Üê Back</button>
                        <button class="btn-gold" id="step2Next" onclick="goStep(3)" disabled style="padding:13px 36px;">Next: Map Columns ‚Üí</button>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ STEP 3: Mapping ‚îÄ‚îÄ -->
                <div class="step-panel" id="panel-3">
                    <div class="section-header">
                        <span class="section-icon">3</span>
                        <span class="section-title">MAP EXCEL COLUMNS TO DHIS2</span>
                    </div>

                    <!-- Org Unit + Period required mappings -->
                    <div class="info-box yellow">
                        <strong>Step A:</strong> Set required columns (Org Unit & Period). <strong>Step B:</strong> Map data element columns ‚Äî columns whose names match a data element are auto-mapped.
                    </div>

                    <div style="background:#f8f9fa;border:2px solid #004080;border-radius:8px;padding:18px;margin-bottom:16px;">
                        <div style="font-size:14px;font-weight:700;color:#004080;margin-bottom:14px;border-bottom:2px solid #004080;padding-bottom:8px;">
                            Required Fields
                        </div>
                        <div class="form-row" style="max-width:750px;">
                            <div class="form-group">
                                <label class="form-label">Org Unit Column <span style="color:red;">*</span></label>
                                <select class="form-select" id="ouColSel" onchange="refreshMapStatus()">
                                    <option value="">-- select --</option>
                                </select>
                                <div style="margin-top:8px;">
                                    <label class="form-label" style="font-size:10px;">Identifier in Excel</label>
                                    <select class="form-select" id="ouIdType" style="font-size:12px;padding:7px 10px;">
                                        <option value="id">DHIS2 UID (e.g. AbCdEf12345)</option>
                                        <option value="name">Name (exact match)</option>
                                        <option value="code">Code</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Period Column <span style="color:red;">*</span></label>
                                <select class="form-select" id="perColSel" onchange="refreshMapStatus()">
                                    <option value="">-- select --</option>
                                </select>
                                <div style="margin-top:8px;">
                                    <label class="form-label" style="font-size:10px;">Period Format</label>
                                    <select class="form-select" id="perFmt" style="font-size:12px;padding:7px 10px;">
                                        <option value="auto">Auto-detect</option>
                                        <option value="YYYYMM">YYYYMM (202301)</option>
                                        <option value="YYYY-MM">YYYY-MM (2023-01)</option>
                                        <option value="MM/YYYY">MM/YYYY (01/2023)</option>
                                        <option value="YYYY">Yearly (2023)</option>
                                        <option value="YYYYQn">Quarterly (2023Q1)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="max-width:360px;margin-top:4px;">
                            <label class="form-label">Default Category Option Combo</label>
                            <select class="form-select" id="defaultCocSel" style="font-size:12px;"></select>
                        </div>
                    </div>

                    <!-- Data element mapping table -->
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <div style="font-size:14px;font-weight:700;color:#28a745;">Data Element Column Mappings</div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn-blue" onclick="autoMapAll()" style="padding:7px 14px;font-size:11px;">‚ö° Auto-Map All</button>
                            <button class="btn-outline-red" onclick="clearMappings()" style="padding:7px 14px;font-size:11px;">‚úï Clear</button>
                        </div>
                    </div>

                    <!-- Status bar -->
                    <div style="display:flex;gap:16px;padding:10px 16px;background:#f8f9fa;border:2px solid #dee2e6;border-radius:6px;margin-bottom:12px;flex-wrap:wrap;font-size:13px;">
                        <span>‚úÖ <strong id="sMapped">0</strong> mapped</span>
                        <span>‚è≠ <strong id="sSkip">0</strong> skipped</span>
                        <span>üî¢ <strong id="sDe">0</strong> dataset elements</span>
                    </div>

                    <div style="overflow-x:auto;">
                        <table class="map-table" id="mapTable">
                            <thead><tr><th>#</th><th>Excel Column Header</th><th>‚Üí DHIS2 Data Element</th><th>Status</th></tr></thead>
                            <tbody id="mapTbody"><tr><td colspan="4" style="text-align:center;color:#999;padding:20px;">Upload file first</td></tr></tbody>
                        </table>
                    </div>

                    <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;">
                        <button class="btn-outline" onclick="goStep(2)">‚Üê Back</button>
                        <button class="btn-gold" onclick="buildPreview()" style="padding:13px 36px;">Next: Preview ‚Üí</button>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ STEP 4: Preview ‚îÄ‚îÄ -->
                <div class="step-panel" id="panel-4">
                    <div class="section-header">
                        <span class="section-icon">4</span>
                        <span class="section-title">PREVIEW UPLOAD DATA</span>
                    </div>

                    <div class="stat-row" id="previewStats"></div>
                    <div id="previewErrors" style="display:none;" class="info-box red"></div>
                    <div id="previewWarnings" style="display:none;" class="info-box yellow"></div>

                    <div style="font-size:13px;font-weight:700;color:#004080;margin:14px 0 6px;">
                        Sample of data values to be uploaded (first 20 rows):
                    </div>
                    <div class="preview-wrap">
                        <table class="preview-table" id="prevTable"></table>
                    </div>

                    <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;">
                        <button class="btn-outline" onclick="goStep(3)">‚Üê Back</button>
                        <button class="btn-gold" id="toUploadBtn" onclick="goStep(5)" disabled style="padding:13px 36px;">Next: Upload ‚Üí</button>
                    </div>
                </div>

                <!-- ‚îÄ‚îÄ STEP 5: Upload ‚îÄ‚îÄ -->
                <div class="step-panel" id="panel-5">
                    <div class="section-header">
                        <span class="section-icon">5</span>
                        <span class="section-title">UPLOAD TO DHIS2</span>
                    </div>

                    <div class="form-row" style="max-width:700px;margin-bottom:16px;">
                        <div class="form-group">
                            <label class="form-label">Import Strategy</label>
                            <select class="form-select" id="stratSel">
                                <option value="CREATE_AND_UPDATE">CREATE_AND_UPDATE (Recommended)</option>
                                <option value="CREATE">CREATE only</option>
                                <option value="UPDATE">UPDATE only</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Batch Size (rows per request)</label>
                            <select class="form-select" id="batchSel">
                                <option value="100">100</option>
                                <option value="250" selected>250</option>
                                <option value="500">500</option>
                                <option value="1000">1000</option>
                            </select>
                        </div>
                    </div>

                    <div class="toggle-row">
                        <input type="checkbox" id="dryRunChk">
                        <label for="dryRunChk">üß™ Dry Run ‚Äî test without saving to DHIS2</label>
                    </div>
                    <div class="toggle-row">
                        <input type="checkbox" id="skipAuditChk">
                        <label for="skipAuditChk">‚ö° Skip Audit Log (faster upload)</label>
                    </div>

                    <div class="stat-row" id="uploadStats" style="margin-top:16px;"></div>

                    <div class="progress-section" id="progressSection">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <strong style="color:#004080;font-size:14px;">Upload Progress</strong>
                            <span id="progressLbl" style="font-size:12px;color:#666;"></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width:0%">0%</div>
                        </div>
                        <div class="log-box" id="logBox"></div>
                    </div>

                    <div id="uploadResult" style="display:none;margin-top:16px;"></div>

                    <div style="margin-top:22px;display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
                        <button class="btn-outline" onclick="goStep(4)">‚Üê Back</button>
                        <button class="btn-green" id="uploadBtn" onclick="startUpload()" style="padding:14px 50px;font-size:15px;">
                            üöÄ UPLOAD TO DHIS2
                        </button>
                        <button class="btn-outline-red" onclick="resetAll()">Reset All</button>
                    </div>
                </div>

            </div><!-- /content-inner -->
        </div><!-- /content-card -->

        <div class="page-footer">
            <p style="font-weight:700;">Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
            <p>Driving Data-Driven Solutions for Health and Development</p>
            <p style="font-size:10px;">¬© 2025 ICF-SL. All rights reserved.</p>
        </div>

    </div><!-- /page-container -->
</div><!-- /main-content -->

<div class="notification" id="notif"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROXY & CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROXY = 'https://script.google.com/macros/s/AKfycbyRXc68PYSmDSCYPakAS8Gc9R00kRjmsMYoDujPYMItyquXfwMAJUtRqXLiDlNWbSfDQQ/exec';
let cfg = null;  // {instanceUrl, username, password}

// Safe JSON parse ‚Äî handles HTML error pages from proxy gracefully
async function safeJson(res) {
    const text = await res.text();
    if (text.trim().startsWith('<')) {
        // Proxy returned an HTML error page
        throw new Error(`Proxy returned an HTML error page (HTTP ${res.status}). The request may not be supported.`);
    }
    try {
        return JSON.parse(text);
    } catch(e) {
        throw new Error(`Invalid JSON from server: ${text.substring(0, 120)}`);
    }
}

function proxyReq(url, opts = {}) {
    let p = `${PROXY}?url=${encodeURIComponent(url)}`;
    const auth = opts.auth || (cfg ? 'Basic ' + btoa(`${cfg.username}:${cfg.password}`) : '');
    if (auth) p += `&Authorization=${encodeURIComponent(auth)}`;
    return fetch(p, { method: 'GET' });   // GET only ‚Äî proxy doesn't support POST body
}

async function dhis2Get(path) {
    const res = await proxyReq(`${cfg.instanceUrl}${path}`);
    if (!res.ok) {
        const t = await res.text();
        throw new Error(`HTTP ${res.status} ‚Äì ${t.startsWith('<') ? 'Server error (HTML response)' : t.substring(0,100)}`);
    }
    return safeJson(res);
}

// POST via proxy: pass payload as URL param so the GAS proxy can forward it as a POST
async function dhis2Post(path, body) {
    const targetUrl = `${cfg.instanceUrl}${path}`;
    const auth = 'Basic ' + btoa(`${cfg.username}:${cfg.password}`);
    const payload = JSON.stringify(body);

    // GAS proxy pattern: method + payload passed as query params
    // The proxy uses UrlFetchApp.fetch(url, {method, payload, headers})
    const proxyUrl = `${PROXY}` +
        `?url=${encodeURIComponent(targetUrl)}` +
        `&Authorization=${encodeURIComponent(auth)}` +
        `&method=POST` +
        `&contentType=application%2Fjson` +
        `&payload=${encodeURIComponent(payload)}`;

    const res = await fetch(proxyUrl);
    return safeJson(res);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATION / LOG / PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function notify(msg, type = 'info') {
    const n = document.getElementById('notif');
    n.textContent = msg; n.className = `notification ${type}`;
    clearTimeout(n._t); n._t = setTimeout(() => n.className = 'notification', 5500);
}

function log(msg, type = 'info') {
    const b = document.getElementById('logBox');
    const d = document.createElement('div');
    d.className = `log-entry ${type}`;
    d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    b.appendChild(d); b.scrollTop = b.scrollHeight;
}

function clearLog() { document.getElementById('logBox').innerHTML = ''; }

function setProg(pct) {
    const f = document.getElementById('progressFill');
    f.style.width = pct + '%'; f.textContent = pct + '%';
    document.getElementById('progressLbl').textContent = pct + '% complete';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const instanceUrl = document.getElementById('instanceUrl').value.trim().replace(/\/$/, '');
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const btn = document.getElementById('loginBtn');
    btn.disabled = true; btn.textContent = 'Connecting...';
    try {
        const auth = 'Basic ' + btoa(`${username}:${password}`);
        const res = await proxyReq(`${instanceUrl}/api/me`, { auth });
        const text = await res.text();
        if (text.trim().startsWith('<')) {
            notify(`Login failed ‚Äî server returned an error page. Check URL & credentials.`, 'error');
            btn.disabled = false; btn.textContent = 'üîó Connect to DHIS2';
            return;
        }
        let user;
        try { user = JSON.parse(text); } catch(e) { notify(`Unexpected response from server`, 'error'); btn.disabled = false; btn.textContent = 'üîó Connect to DHIS2'; return; }
        if (res.ok && user.id) {
            cfg = { instanceUrl, username, password };
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('active');
            notify(`Connected! Welcome ${(user.firstName || '') + ' ' + (user.surname || '')}`.trim(), 'success');
            loadOuLevels();
            loadCOCs();
        } else {
            notify(`Login failed (${res.status}) ‚Äî check credentials`, 'error');
        }
    } catch (err) {
        notify(`Connection error: ${err.message}`, 'error');
    } finally { btn.disabled = false; btn.textContent = 'üîó Connect to DHIS2'; }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentStep = 1;
function goStep(n) {
    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(`panel-${n}`).classList.add('active');
    document.querySelectorAll('.step-tab').forEach((t, i) => {
        t.classList.remove('active', 'done');
        if (i + 1 === n) t.classList.add('active');
        else if (i + 1 < n) t.classList.add('done');
    });
    currentStep = n;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DHIS2 METADATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allDatasets = [];
let selectedDataset = null;   // {id, name, dataElements:[{id,displayName}], periodType}
let ouLevels = [];            // [{id, level, displayName}]
let dhis2COCs = [];
let selectedOuLevel = null;

async function loadOuLevels() {
    try {
        const data = await dhis2Get('/api/organisationUnitLevels.json?fields=id,level,displayName&paging=false&order=level:asc');
        ouLevels = data.organisationUnitLevels || [];
        const sel = document.getElementById('ouLevelSelect');
        sel.innerHTML = '<option value="">-- Select level --</option>' +
            ouLevels.map(l => `<option value="${l.id}" data-level="${l.level}">${l.displayName} (Level ${l.level})</option>`).join('');
    } catch(e) {
        console.error('OU levels:', e);
    }
}

async function loadCOCs() {
    try {
        const data = await dhis2Get('/api/categoryOptionCombos.json?fields=id,displayName,name&paging=false');
        dhis2COCs = data.categoryOptionCombos || [];
        const sel = document.getElementById('defaultCocSel');
        const def = dhis2COCs.find(c => /default/i.test(c.displayName || c.name)) || dhis2COCs[0];
        sel.innerHTML = dhis2COCs.map(c => `<option value="${c.id}" ${c.id === def?.id ? 'selected' : ''}>${c.displayName || c.name}</option>`).join('');
    } catch(e) { console.error('COCs:', e); }
}

async function loadDatasets() {
    const btn = document.getElementById('loadDatasetsBtn');
    const status = document.getElementById('dsLoadStatus');
    btn.disabled = true; btn.textContent = '‚è≥ Loading...';
    try {
        notify('Loading datasets...', 'info');
        const data = await dhis2Get('/api/dataSets.json?fields=id,displayName,name,periodType,dataSetElements[dataElement[id,displayName,name,code]]&paging=false');
        allDatasets = data.dataSets || [];
        const sel = document.getElementById('datasetSelect');
        sel.innerHTML = '<option value="">-- Select a dataset --</option>' +
            allDatasets.map(ds => `<option value="${ds.id}">${ds.displayName || ds.name}</option>`).join('');
        status.textContent = `‚úÖ ${allDatasets.length} datasets loaded`;
        notify(`Loaded ${allDatasets.length} datasets`, 'success');
    } catch(err) {
        status.textContent = `‚úó ${err.message}`;
        notify(`Failed: ${err.message}`, 'error');
    } finally { btn.disabled = false; btn.textContent = 'üîÑ Load All Datasets'; }
}

function onDatasetChange() {
    const id = document.getElementById('datasetSelect').value;
    if (!id) { document.getElementById('datasetInfo').style.display = 'none'; selectedDataset = null; checkStep1(); return; }
    selectedDataset = allDatasets.find(ds => ds.id === id);
    if (!selectedDataset) return;
    const des = selectedDataset.dataSetElements?.map(e => e.dataElement) || [];
    document.getElementById('datasetInfo').style.display = 'block';
    document.getElementById('datasetInfo').innerHTML =
        `<strong>Dataset:</strong> ${esc(selectedDataset.displayName || selectedDataset.name)}<br>
         <strong>Period Type:</strong> ${selectedDataset.periodType || 'N/A'}<br>
         <strong>Data Elements:</strong> ${des.length}<br>
         <strong>Sample elements:</strong> ${des.slice(0,4).map(d => esc(d.displayName || d.name)).join(', ')}${des.length > 4 ? ' ...' : ''}`;
    checkStep1();
    if (excelHeaders.length) buildMappingTable();
}

function onOuLevelChange() {
    const sel = document.getElementById('ouLevelSelect');
    const opt = sel.options[sel.selectedIndex];
    selectedOuLevel = opt.value ? { id: opt.value, level: parseInt(opt.dataset.level), name: opt.text } : null;
    checkStep1();
}

function checkStep1() {
    document.getElementById('step1Next').disabled = !(selectedDataset && selectedOuLevel);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let wb = null;
let excelHeaders = [];
let excelRows = [];

const dz = document.getElementById('dropZone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); });

function handleFile(e) { if (e.target.files[0]) processFile(e.target.files[0]); }

function clearFile(e) {
    e.stopPropagation();
    wb = null; excelHeaders = []; excelRows = [];
    document.getElementById('fileBadge').style.display = 'none';
    document.getElementById('sheetRow').style.display = 'none';
    document.getElementById('fileInput').value = '';
    document.getElementById('step2Next').disabled = true;
}

function processFile(file) {
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array', cellDates: true });
            document.getElementById('fileNameLbl').textContent = `${file.name}  (${(file.size/1024).toFixed(1)} KB)`;
            document.getElementById('fileBadge').style.display = 'flex';
            const sel = document.getElementById('sheetSel');
            sel.innerHTML = wb.SheetNames.map((s, i) => `<option value="${i}">${s}</option>`).join('');
            document.getElementById('sheetRow').style.display = 'block';
            reloadSheet();
            notify(`Loaded: ${file.name}`, 'success');
        } catch(err) { notify(`Read error: ${err.message}`, 'error'); }
    };
    reader.readAsArrayBuffer(file);
}

function reloadSheet() {
    if (!wb) return;
    const idx = parseInt(document.getElementById('sheetSel').value) || 0;
    const hRow = Math.max(1, parseInt(document.getElementById('headerRow').value) || 1);
    const sheet = wb.Sheets[wb.SheetNames[idx]];
    const raw = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
    if (raw.length < hRow) return;
    excelHeaders = raw[hRow - 1].map(h => String(h).trim());
    excelRows = raw.slice(hRow).filter(r => r.some(c => c !== '' && c !== null && c !== undefined));
    document.getElementById('rawInfo').textContent = `${excelRows.length} data rows ¬∑ ${excelHeaders.length} columns`;
    renderRaw();
    document.getElementById('step2Next').disabled = excelRows.length === 0;
    if (selectedDataset) buildMappingTable();
    populateColDropdowns();
}

function renderRaw() {
    let h = '<thead><tr><th>#</th>' + excelHeaders.map(h => `<th>${esc(h)}</th>`).join('') + '</tr></thead><tbody>';
    excelRows.slice(0, 5).forEach((r, i) => {
        h += `<tr><td style="color:#aaa;font-size:11px;">${i+1}</td>` + excelHeaders.map((_, ci) => {
            const v = r[ci] !== undefined ? String(r[ci]) : '';
            return `<td class="${v ? 'v-ok' : 'v-empty'}">${esc(v) || '‚Äì'}</td>`;
        }).join('') + '</tr>';
    });
    h += '</tbody>';
    document.getElementById('rawTable').innerHTML = h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN MAPPING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let colMaps = {};  // colIndex -> {type:'de'|'skip', deId, deName}

function populateColDropdowns() {
    const opts = excelHeaders.map((h, i) => `<option value="${i}">${esc(h)}</option>`).join('');
    const blank = '<option value="">-- select --</option>';
    ['ouColSel','perColSel'].forEach(id => {
        document.getElementById(id).innerHTML = blank + opts;
    });
    // Auto-guess
    const ouG = excelHeaders.findIndex(h => /org.?unit|facility|uid|site|hf/i.test(h));
    const pG = excelHeaders.findIndex(h => /period|month|date|year/i.test(h));
    if (ouG >= 0) document.getElementById('ouColSel').value = ouG;
    if (pG >= 0) document.getElementById('perColSel').value = pG;
}

function buildMappingTable() {
    if (!selectedDataset || !excelHeaders.length) return;
    const des = (selectedDataset.dataSetElements || []).map(e => e.dataElement);
    colMaps = {};
    const tbody = document.getElementById('mapTbody');
    tbody.innerHTML = '';

    excelHeaders.forEach((header, i) => {
        const match = findDeMatch(header, des);
        colMaps[i] = match ? { type: 'de', deId: match.id, deName: match.displayName || match.name } : { type: 'skip' };

        const sel = document.createElement('select');
        sel.id = `cm-${i}`;
        sel.style.cssText = 'width:100%;padding:7px 10px;border:2px solid #004080;border-radius:4px;font-family:Oswald,Arial,sans-serif;font-size:12px;';
        sel.innerHTML = `<option value="__skip__">-- Skip --</option>` +
            des.map(de => `<option value="${de.id}" ${de.id === match?.id ? 'selected':''}>${esc(de.displayName || de.name)}</option>`).join('');
        sel.onchange = () => {
            const v = sel.value;
            if (v === '__skip__') colMaps[i] = { type: 'skip' };
            else {
                const de = des.find(d => d.id === v);
                colMaps[i] = { type: 'de', deId: v, deName: de?.displayName || de?.name || v };
            }
            refreshMapStatus();
        };

        const statusBadge = match
            ? `<span class="auto-badge">AUTO ‚úì</span>`
            : `<span class="skip-badge">unmapped</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="color:#aaa;font-size:11px;">${i+1}</td>
            <td><strong>${esc(header)}</strong></td>
            <td></td>
            <td>${statusBadge}</td>`;
        tr.cells[2].appendChild(sel);

        // Update badge on change
        sel.addEventListener('change', () => {
            tr.cells[3].innerHTML = sel.value === '__skip__'
                ? `<span class="skip-badge">skipped</span>`
                : `<span class="mapped-badge">mapped</span>`;
        });

        tbody.appendChild(tr);
    });

    document.getElementById('sDe').textContent = des.length;
    refreshMapStatus();
}

function findDeMatch(header, des) {
    const h = header.toLowerCase().replace(/[^a-z0-9]/g, ' ').trim();
    return des.find(de => {
        const n = (de.displayName || de.name || '').toLowerCase().replace(/[^a-z0-9]/g, ' ').trim();
        return n === h || n.includes(h) || h.includes(n);
    }) || null;
}

function autoMapAll() {
    if (!selectedDataset) return;
    const des = (selectedDataset.dataSetElements || []).map(e => e.dataElement);
    excelHeaders.forEach((header, i) => {
        const match = findDeMatch(header, des);
        const sel = document.getElementById(`cm-${i}`);
        if (match && sel) {
            sel.value = match.id;
            colMaps[i] = { type: 'de', deId: match.id, deName: match.displayName || match.name };
        }
    });
    refreshMapStatus();
    notify('Auto-mapped all matching columns', 'success');
}

function clearMappings() {
    excelHeaders.forEach((_, i) => {
        const sel = document.getElementById(`cm-${i}`);
        if (sel) sel.value = '__skip__';
        colMaps[i] = { type: 'skip' };
    });
    refreshMapStatus();
}

function refreshMapStatus() {
    let mapped = 0, skip = 0;
    Object.values(colMaps).forEach(m => m.type === 'de' ? mapped++ : skip++);
    document.getElementById('sMapped').textContent = mapped;
    document.getElementById('sSkip').textContent = skip;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 4: PREVIEW & VALIDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let payload = [];  // final DHIS2 data values

function buildPreview() {
    const ouCol = parseInt(document.getElementById('ouColSel').value);
    const perCol = parseInt(document.getElementById('perColSel').value);
    if (isNaN(ouCol) || document.getElementById('ouColSel').value === '') { notify('Select Org Unit column', 'error'); return; }
    if (isNaN(perCol) || document.getElementById('perColSel').value === '') { notify('Select Period column', 'error'); return; }

    const mappedCols = Object.entries(colMaps).filter(([, m]) => m.type === 'de');
    if (!mappedCols.length) { notify('Map at least one data element column', 'error'); return; }

    const ouIdType = document.getElementById('ouIdType').value;
    const perFmt = document.getElementById('perFmt').value;
    const defaultCoc = document.getElementById('defaultCocSel').value;

    payload = [];
    const errors = [];
    const warnings = [];
    let emptyValues = 0;

    excelRows.forEach((row, ri) => {
        const ouRaw = String(row[ouCol] || '').trim();
        const perRaw = String(row[perCol] || '').trim();
        if (!ouRaw && !perRaw) return; // blank row

        const period = parsePeriod(perRaw, perFmt);
        if (!period) { errors.push(`Row ${ri + 2}: Cannot parse period "${perRaw}"`); return; }
        if (!ouRaw) { errors.push(`Row ${ri + 2}: Empty org unit`); return; }

        // Org unit: pass through UID/code directly; name lookup if needed
        let orgUnit = ouRaw;
        // (Name->UID matching not done here since user selects ID type;
        //  if name is selected, server will accept name with identifiableObjects)

        mappedCols.forEach(([ci, m]) => {
            const val = row[parseInt(ci)];
            if (val === '' || val === null || val === undefined) { emptyValues++; return; }
            payload.push({
                dataElement: m.deId,
                period,
                orgUnit,
                categoryOptionCombo: defaultCoc,
                value: String(val)
            });
        });
    });

    if (emptyValues > 0) warnings.push(`${emptyValues} empty cells skipped (will not be uploaded)`);

    // Stats
    const periods = [...new Set(payload.map(v => v.period))];
    const ous = [...new Set(payload.map(v => v.orgUnit))];
    const des = [...new Set(payload.map(v => v.dataElement))];

    document.getElementById('previewStats').innerHTML = `
        <div class="stat-card blue"><div class="stat-num">${payload.length}</div><div class="stat-label">Values Ready</div></div>
        <div class="stat-card"><div class="stat-num">${ous.length}</div><div class="stat-label">Org Units</div></div>
        <div class="stat-card"><div class="stat-num">${periods.length}</div><div class="stat-label">Periods</div></div>
        <div class="stat-card"><div class="stat-num">${des.length}</div><div class="stat-label">Data Elements</div></div>
        <div class="stat-card ${errors.length > 0 ? 'red' : 'green'}"><div class="stat-num">${errors.length}</div><div class="stat-label">Row Errors</div></div>
    `;

    const errDiv = document.getElementById('previewErrors');
    const warnDiv = document.getElementById('previewWarnings');
    if (errors.length) {
        errDiv.style.display = 'block';
        errDiv.innerHTML = `<strong>‚õî Errors (${errors.length}):</strong><br>` + errors.slice(0, 10).map(esc).join('<br>') + (errors.length > 10 ? `<br>...and ${errors.length - 10} more` : '');
    } else errDiv.style.display = 'none';

    if (warnings.length) {
        warnDiv.style.display = 'block';
        warnDiv.innerHTML = `<strong>‚ö† Warnings:</strong><br>` + warnings.map(esc).join('<br>');
    } else warnDiv.style.display = 'none';

    // Preview table
    const cols = mappedCols.map(([, m]) => m.deName);
    let h = `<thead><tr><th>Row</th><th>Org Unit</th><th>Period</th>${cols.map(c => `<th>${esc(c)}</th>`).join('')}</tr></thead><tbody>`;
    excelRows.slice(0, 20).forEach((row, ri) => {
        const ouRaw = String(row[ouCol] || '').trim();
        const perRaw = String(row[perCol] || '').trim();
        const period = parsePeriod(perRaw, perFmt);
        h += `<tr><td style="color:#aaa;font-size:11px;">${ri+1}</td>
            <td class="${ouRaw ? 'v-ok' : 'v-empty'}">${esc(ouRaw) || '‚Äì'}</td>
            <td class="${period ? 'v-ok' : 'v-empty'}">${period || esc(perRaw)}</td>
            ${mappedCols.map(([ci]) => {
                const v = row[parseInt(ci)];
                const s = v !== '' && v !== null && v !== undefined ? esc(String(v)) : '';
                return `<td class="${s ? 'v-ok' : 'v-empty'}">${s || '‚Äì'}</td>`;
            }).join('')}
        </tr>`;
    });
    h += '</tbody>';
    document.getElementById('prevTable').innerHTML = h;

    const canUpload = payload.length > 0;
    document.getElementById('toUploadBtn').disabled = !canUpload;

    goStep(4);
    notify(canUpload ? `Preview ready: ${payload.length} values` : 'No valid values found', canUpload ? 'success' : 'warning');
}

function parsePeriod(val, fmt) {
    val = String(val || '').trim();
    // Handle Excel date numbers
    if (/^\d{5}$/.test(val)) return null; // likely raw Excel date serial
    if (fmt === 'YYYYMM' || fmt === 'auto') if (/^\d{6}$/.test(val)) return val;
    if (fmt === 'YYYY-MM' || fmt === 'auto') if (/^\d{4}-\d{2}$/.test(val)) return val.replace('-','');
    if (fmt === 'MM/YYYY' || fmt === 'auto') { const m = val.match(/^(\d{1,2})\/(\d{4})$/); if (m) return m[2] + m[1].padStart(2,'0'); }
    if (fmt === 'YYYY' || fmt === 'auto') if (/^\d{4}$/.test(val)) return val;
    if (fmt === 'YYYYQn' || fmt === 'auto') if (/^\d{4}Q[1-4]$/i.test(val)) return val.toUpperCase();
    // auto fallback
    if (/^\d{6}$/.test(val)) return val;
    if (/^\d{4}-\d{2}$/.test(val)) return val.replace('-','');
    if (/^\d{4}$/.test(val)) return val;
    const m = val.match(/^(\d{1,2})\/(\d{4})$/);
    if (m) return m[2] + m[1].padStart(2,'0');
    return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 5: UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startUpload() {
    if (!payload.length) { notify('Nothing to upload', 'error'); return; }
    const btn = document.getElementById('uploadBtn');
    btn.disabled = true; btn.textContent = '‚è≥ Uploading...';
    document.getElementById('progressSection').classList.add('active');
    document.getElementById('uploadResult').style.display = 'none';
    clearLog(); setProg(0);

    const strategy = document.getElementById('stratSel').value;
    const batchSize = parseInt(document.getElementById('batchSel').value);
    const dryRun = document.getElementById('dryRunChk').checked;
    const skipAudit = document.getElementById('skipAuditChk').checked;

    const batches = [];
    for (let i = 0; i < payload.length; i += batchSize) batches.push(payload.slice(i, i + batchSize));

    let imported = 0, updated = 0, ignored = 0, errors = 0;
    log(`Starting upload: ${payload.length} values ¬∑ ${batches.length} batch(es)`, 'info');
    log(`Strategy: ${strategy} | Dry Run: ${dryRun}`, 'info');
    log(`Dataset: ${selectedDataset?.displayName || selectedDataset?.name}`, 'info');

    document.getElementById('uploadStats').innerHTML = `
        <div class="stat-card blue"><div class="stat-num">${payload.length}</div><div class="stat-label">Total Values</div></div>
        <div class="stat-card"><div class="stat-num">${batches.length}</div><div class="stat-label">Batches</div></div>
        ${dryRun ? '<div class="stat-card gold"><div class="stat-num">DRY</div><div class="stat-label">Dry Run Mode</div></div>' : ''}
    `;

    for (let b = 0; b < batches.length; b++) {
        const batch = batches[b];
        setProg(Math.round((b / batches.length) * 90));
        log(`Batch ${b+1}/${batches.length}: ${batch.length} values...`, 'info');
        try {
            let qs = `importStrategy=${strategy}&dryRun=${dryRun}`;
            if (skipAudit) qs += '&skipAudit=true';

            // dhis2Post now returns parsed JSON (or throws on error/HTML)
            const data = await dhis2Post(`/api/dataValueSets?${qs}`, { dataValues: batch });

            const ic = data.importCount || data.response?.importCount || {};
            imported += ic.imported || 0;
            updated += ic.updated || 0;
            ignored += ic.ignored || 0;
            const bErr = ic.ignored || 0;
            log(`Batch ${b+1}: ‚úì${ic.imported||0} imported ¬∑ ‚Üë${ic.updated||0} updated ¬∑ ‚úó${ic.ignored||0} ignored`, bErr > 0 ? 'warning' : 'success');

            // Log conflicts
            const conflicts = data.conflicts || data.response?.conflicts || [];
            conflicts.slice(0, 2).forEach(c => log(`  ‚Ü≥ ${c.value || JSON.stringify(c)}`, 'warning'));
        } catch(err) {
            log(`Batch ${b+1} error: ${err.message}`, 'error');
            errors += batch.length;
        }
        if (b < batches.length - 1) await new Promise(r => setTimeout(r, 150));
    }

    setProg(100);
    const ok = imported + updated > 0;
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', ok ? 'success' : 'warning');
    log(`${dryRun ? 'DRY RUN ' : ''}UPLOAD COMPLETE ¬∑ Imported:${imported} Updated:${updated} Ignored:${ignored} Errors:${errors}`, ok ? 'success' : 'warning');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', ok ? 'success' : 'warning');

    document.getElementById('uploadStats').innerHTML = `
        <div class="stat-card ${imported > 0 ? 'green' : ''}"><div class="stat-num">${imported}</div><div class="stat-label">Imported</div></div>
        <div class="stat-card ${updated > 0 ? 'green' : ''}"><div class="stat-num">${updated}</div><div class="stat-label">Updated</div></div>
        <div class="stat-card ${ignored > 0 ? 'red' : ''}"><div class="stat-num">${ignored}</div><div class="stat-label">Ignored</div></div>
        <div class="stat-card ${errors > 0 ? 'red' : 'green'}"><div class="stat-num">${errors}</div><div class="stat-label">Errors</div></div>
    `;

    const res = document.getElementById('uploadResult');
    res.style.display = 'block';
    res.innerHTML = `<div class="info-box ${ok ? 'green' : 'yellow'}">
        <strong>${dryRun ? 'üß™ Dry Run Complete' : '‚úÖ Upload Complete'}</strong><br>
        ${imported} imported ¬∑ ${updated} updated${ignored > 0 ? ` ¬∑ ${ignored} ignored` : ''}${errors > 0 ? ` ¬∑ ${errors} errors` : ''}.
        ${dryRun ? ' No data was saved (dry run mode).' : ''}
    </div>`;

    notify(ok ? 'Upload complete!' : 'Finished with issues', ok ? 'success' : 'warning');
    btn.disabled = false; btn.textContent = 'üöÄ UPLOAD TO DHIS2';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetAll() {
    wb = null; excelHeaders = []; excelRows = []; colMaps = {}; payload = [];
    selectedDataset = null; selectedOuLevel = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('fileBadge').style.display = 'none';
    document.getElementById('sheetRow').style.display = 'none';
    document.getElementById('step2Next').disabled = true;
    document.getElementById('step1Next').disabled = true;
    document.getElementById('datasetSelect').value = '';
    document.getElementById('datasetInfo').style.display = 'none';
    document.getElementById('ouLevelSelect').value = '';
    document.getElementById('mapTbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;padding:20px;">Upload file first</td></tr>';
    document.getElementById('progressSection').classList.remove('active');
    document.getElementById('uploadResult').style.display = 'none';
    document.getElementById('uploadStats').innerHTML = '';
    document.getElementById('previewStats').innerHTML = '';
    goStep(1);
    notify('Reset complete', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
