<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DHIS2 Bulk Upload â€” ICF-SL</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#f0f4f8;font-family:'Oswald',sans-serif;color:#000;font-weight:500;min-height:100vh;}

/* LOGIN */
.login-screen{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#004080,#0066cc);}
.login-card{background:#fff;border-radius:12px;padding:38px;max-width:460px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.25);border:4px double #004080;}
.lc{display:flex;justify-content:center;margin-bottom:20px;}
.logo-box{background:#f8f9fa;border-radius:8px;padding:10px;border:2px solid #004080;display:inline-block;}
.logo-box img{width:90px;display:block;border-radius:5px;}
.lt{text-align:center;margin-bottom:26px;}
.lt h1{color:#004080;font-size:20px;font-weight:700;letter-spacing:1px;margin-bottom:4px;}
.lt p{color:#666;font-size:12px;}
.fg{margin-bottom:16px;}
.fl{display:block;color:#004080;font-size:11px;font-weight:700;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
.fi{width:100%;padding:11px 14px;border:2px solid #004080;border-radius:6px;font-size:13px;font-family:'Oswald',sans-serif;font-weight:500;color:#000;background:#fff;}
.fi:focus{outline:none;border-color:#0056b3;box-shadow:0 0 0 3px rgba(0,64,128,.12);}
.fi::placeholder{color:#bbb;}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.btn-connect{width:100%;padding:13px;background:#004080;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:700;cursor:pointer;text-transform:uppercase;font-family:'Oswald',sans-serif;margin-top:4px;}
.btn-connect:hover{background:#0056b3;}
.btn-connect:disabled{background:#888;cursor:wait;}

/* MAIN */
.main{display:none;padding:18px;}
.main.show{display:block;}
.wrap{max-width:1200px;margin:0 auto;}

/* PAGE HEADER */
.ph{background:#004080;color:#fff;padding:22px 28px;text-align:center;border-radius:8px 8px 0 0;}
.ph .logo-box{background:#fff;border:none;}
.ph h3{font-size:12px;font-weight:700;letter-spacing:1px;margin:10px 0 3px;}
.ph .it{font-size:10px;margin-bottom:10px;font-style:italic;}
.ph h1{font-size:22px;font-weight:700;letter-spacing:1px;margin-bottom:5px;}
.ph .sub{font-size:12px;}

/* CARD */
.card{border:4px double #004080;border-top:none;border-radius:0 0 12px 12px;background:#fff;margin-bottom:14px;}
.ci{padding:26px;}

/* SECTION HEAD */
.sh{background:#004080;color:#fff;padding:12px 16px;margin-bottom:16px;border-radius:6px;display:flex;align-items:center;gap:11px;}
.snum{background:#fff;color:#004080;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;}
.stitle{font-size:14px;font-weight:700;letter-spacing:.5px;}

/* TABS */
.tabs{display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap;}
.tab{padding:9px 16px;background:#e9ecef;border:2px solid #dee2e6;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;font-family:'Oswald',sans-serif;color:#888;display:flex;align-items:center;gap:6px;}
.tab.on{background:#004080;color:#fff;border-color:#004080;}
.tab.done{background:#d4edda;color:#155724;border-color:#28a745;}
.tab .tn{width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;}
.tab.done .tn{background:#28a745;color:#fff;}
.panel{display:none;}
.panel.on{display:block;}

/* GRID / BOXES */
.cg{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
.cb{background:#f8f9fa;border:2px solid #004080;border-radius:8px;padding:16px;}
.cb label{display:block;color:#004080;font-size:11px;font-weight:700;margin-bottom:7px;text-transform:uppercase;letter-spacing:.5px;}
.cb select,.cb .fi{width:100%;padding:10px 12px;border:2px solid #004080;border-radius:6px;font-size:13px;font-family:'Oswald',sans-serif;font-weight:500;}
.hint{font-size:11px;color:#666;margin-top:6px;line-height:1.5;}

/* STATS */
.stats{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0;}
.st{flex:1;min-width:105px;background:#f8f9fa;border:2px solid #dee2e6;border-radius:8px;padding:12px;text-align:center;}
.st.blue{border-color:#004080;background:#e7f3ff;}
.st.green{border-color:#28a745;background:#d4edda;}
.st.red{border-color:#dc3545;background:#f8d7da;}
.st.gold{border-color:#ffc107;background:#fff3cd;}
.sv{font-size:26px;font-weight:700;color:#004080;line-height:1;}
.st.green .sv{color:#155724;}
.st.red .sv{color:#721c24;}
.st.gold .sv{color:#856404;}
.sk{font-size:10px;color:#666;margin-top:4px;text-transform:uppercase;letter-spacing:.3px;}

/* DROP ZONE */
.dz{border:3px dashed #004080;border-radius:10px;padding:42px 20px;text-align:center;background:#f0f7ff;cursor:pointer;position:relative;}
.dz:hover,.dz.over{background:#d9ecff;}
.dz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.dz-ico{font-size:52px;margin-bottom:10px;}
.dz-ttl{font-size:18px;font-weight:700;color:#004080;margin-bottom:6px;}
.dz-sub{font-size:12px;color:#777;}
.fbadge{display:inline-flex;align-items:center;gap:10px;background:#d4edda;border:2px solid #28a745;border-radius:8px;padding:9px 16px;margin-top:13px;font-size:13px;font-weight:600;color:#155724;}
.rm{background:#dc3545;color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* INFO BOXES */
.ib{padding:11px 16px;border-radius:6px;margin:10px 0;font-size:12px;line-height:1.7;}
.ib.blue{background:#e7f3ff;border:2px solid #004080;color:#004080;}
.ib.green{background:#d4edda;border:2px solid #28a745;color:#155724;}
.ib.yellow{background:#fff3cd;border:2px solid #ffc107;color:#856404;}
.ib.red{background:#f8d7da;border:2px solid #dc3545;color:#721c24;}

/* TABLES */
.tw{overflow-x:auto;max-height:260px;overflow-y:auto;border:2px solid #004080;border-radius:8px;margin:10px 0;}
.tbl{width:100%;border-collapse:collapse;font-size:12px;}
.tbl th{background:#004080;color:#fff;padding:9px 12px;text-align:left;position:sticky;top:0;white-space:nowrap;font-weight:600;}
.tbl td{padding:7px 12px;border-bottom:1px solid #e9ecef;white-space:nowrap;}
.tbl tr:nth-child(even) td{background:#f8f9fa;}
.tbl tr:hover td{background:#e7f3ff;}
.bk{display:inline-block;padding:2px 9px;border-radius:10px;font-size:10px;font-weight:700;}
.bk.ok{background:#28a745;color:#fff;}
.bk.skip{background:#aaa;color:#fff;}
.bk.warn{background:#ffc107;color:#000;}
.vok{color:#155724;font-weight:600;}
.vno{color:#ccc;}

/* PROGRESS */
.prg{display:none;background:#f8f9fa;border:2px solid #004080;border-radius:8px;padding:16px;margin:16px 0;}
.prg.on{display:block;}
.prg-top{display:flex;justify-content:space-between;margin-bottom:4px;}
.prg-bar{height:26px;background:#e9ecef;border-radius:6px;overflow:hidden;border:2px solid #004080;margin:8px 0;}
.prg-fill{height:100%;background:linear-gradient(90deg,#004080,#0066cc);transition:width .3s;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700;min-width:35px;}
.log{margin-top:12px;max-height:240px;overflow-y:auto;background:#1a1a2e;border-radius:6px;padding:12px 14px;font-family:'Courier New',monospace;font-size:12px;}
.ll{padding:2px 0;}
.ll.i{color:#17a2b8;}
.ll.s{color:#28a745;}
.ll.e{color:#dc3545;}
.ll.w{color:#ffc107;}

/* BUTTONS */
.btn{padding:11px 22px;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Oswald',sans-serif;border:2px solid;}
.btn.blue{background:#004080;color:#fff;border-color:#004080;}
.btn.blue:hover{background:#0056b3;}
.btn.blue:disabled{background:#888;border-color:#888;cursor:wait;}
.btn.gold{background:#ffc107;color:#000;border-color:#ffc107;}
.btn.gold:hover{background:#e0a800;}
.btn.gold:disabled{background:#e9ecef;color:#888;border-color:#ccc;cursor:wait;}
.btn.green{background:#28a745;color:#fff;border-color:#28a745;}
.btn.green:hover{background:#218838;}
.btn.green:disabled{background:#888;border-color:#888;cursor:wait;}
.btn.outline{background:#fff;color:#004080;border-color:#004080;}
.btn.outline:hover{background:#004080;color:#fff;}
.btn.danger{background:#fff;color:#dc3545;border-color:#dc3545;}
.btn.danger:hover{background:#dc3545;color:#fff;}
.btn.lg{padding:14px 44px;font-size:15px;}
.brow{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;}

/* TOGGLE */
.tog{display:flex;align-items:center;gap:9px;padding:7px 0;}
.tog input{width:17px;height:17px;accent-color:#004080;cursor:pointer;}
.tog label{font-size:13px;cursor:pointer;}

/* NOTIFICATION */
.ntf{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 26px;border-radius:8px;font-weight:600;z-index:9999;display:none;box-shadow:0 4px 14px rgba(0,0,0,.2);min-width:250px;text-align:center;font-size:13px;}
.ntf.s{background:#d4edda;color:#155724;border:2px solid #28a745;display:block;}
.ntf.e{background:#f8d7da;color:#721c24;border:2px solid #dc3545;display:block;}
.ntf.i{background:#e7f3ff;color:#004080;border:2px solid #004080;display:block;}
.ntf.w{background:#fff3cd;color:#856404;border:2px solid #ffc107;display:block;}

.footer{background:#004080;color:#fff;padding:16px;text-align:center;font-size:12px;line-height:1.8;border-radius:0 0 8px 8px;}

::-webkit-scrollbar{width:7px;height:7px;}
::-webkit-scrollbar-thumb{background:#004080;border-radius:4px;}
::-webkit-scrollbar-track{background:#f0f4f8;}

@media(max-width:700px){.cg,.fr2{grid-template-columns:1fr;}.stats{gap:6px;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="lc">
      <div class="logo-box">
        <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" alt="ICF-SL">
      </div>
    </div>
    <div class="lt">
      <h1>DHIS2 BULK DATASET UPLOAD</h1>
      <p>ICF-SL Â· Push Excel data directly into DHIS2</p>
    </div>
    <form id="loginForm">
      <div class="fg">
        <label class="fl">DHIS2 Instance URL</label>
        <input type="url" class="fi" id="iUrl" placeholder="https://sl.dhis2.org/hmis23" required>
      </div>
      <div class="fr2">
        <div class="fg">
          <label class="fl">Username</label>
          <input type="text" class="fi" id="iUser" placeholder="admin" required autocomplete="username">
        </div>
        <div class="fg">
          <label class="fl">Password</label>
          <input type="password" class="fi" id="iPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password">
        </div>
      </div>
      <button type="submit" class="btn-connect" id="loginBtn">ğŸ”— Connect to DHIS2</button>
    </form>
  </div>
</div>

<!-- MAIN -->
<div class="main" id="mainDiv">
  <div class="wrap">

    <div class="ph">
      <div class="lc">
        <div class="logo-box">
          <img src="https://github.com/mohamedsillahkanu/gdp-dashboard-2/raw/6c7463b0d5c3be150aafae695a4bcbbd8aeb1499/ICF-SL.jpg" style="width:80px;">
        </div>
      </div>
      <h3>Informatics Consultancy Firm-Sierra Leone (ICF-SL)</h3>
      <p class="it">Driving Data-Driven Solutions for Health and Development</p>
      <h1>ğŸ“¤ DHIS2 BULK DATASET UPLOAD</h1>
      <p class="sub">Select dataset Â· Select org unit level Â· Upload Excel Â· Auto-match Â· Push to DHIS2</p>
    </div>

    <div class="card">
      <div class="ci">

        <!-- TABS -->
        <div class="tabs">
          <div class="tab on"  id="tab1" onclick="go(1)"><span class="tn">1</span>Configure</div>
          <div class="tab"     id="tab2" onclick="go(2)"><span class="tn">2</span>Upload Excel</div>
          <div class="tab"     id="tab3" onclick="go(3)"><span class="tn">3</span>Review</div>
          <div class="tab"     id="tab4" onclick="go(4)"><span class="tn">4</span>Push to DHIS2</div>
        </div>

        <!-- STEP 1: CONFIGURE -->
        <div class="panel on" id="p1">
          <div class="sh"><span class="snum">1</span><span class="stitle">SELECT DATASET &amp; ORG UNIT LEVEL</span></div>

          <div class="ib blue">
            Load all DHIS2 metadata, then choose your <strong>target dataset</strong> and the
            <strong>org unit level</strong> where data is collected.
            Org unit names and data element columns will be matched automatically from your Excel file.
          </div>

          <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:18px;">
            <button class="btn blue" id="metaBtn" onclick="loadMeta()">ğŸ”„ Load Datasets &amp; Org Unit Levels</button>
            <span id="metaMsg" style="font-size:13px;color:#666;"></span>
          </div>

          <div class="cg">
            <div class="cb">
              <label>Target Dataset</label>
              <select id="dsSel" onchange="onDs()"><option value="">-- load metadata first --</option></select>
              <div class="hint" id="dsHint" style="display:none;"></div>
            </div>
            <div class="cb">
              <label>Org Unit Level</label>
              <select id="lvlSel" onchange="onLvl()"><option value="">-- load metadata first --</option></select>
              <div class="hint">Select the level where your health facilities are. Then click <strong>Load Org Units</strong>.</div>
            </div>
          </div>

          <div id="ouRow" style="display:none;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:18px;">
            <button class="btn blue" id="ouBtn" onclick="loadOUs()">ğŸ“ Load Org Units at Selected Level</button>
            <span id="ouMsg" style="font-size:13px;color:#666;"></span>
          </div>

          <div class="brow">
            <button class="btn gold lg" id="s1next" onclick="go(2)" disabled>Next: Upload Excel â†’</button>
          </div>
        </div>

        <!-- STEP 2: EXCEL -->
        <div class="panel" id="p2">
          <div class="sh"><span class="snum">2</span><span class="stitle">UPLOAD YOUR EXCEL FILE</span></div>

          <div class="ib blue">
            <strong>Fixed column order â€” no selection or mapping needed:</strong><br>
            &nbsp;&nbsp;â€¢ <strong>Column A:</strong> Organisation Unit Name &nbsp;(must match DHIS2 org unit names at selected level)<br>
            &nbsp;&nbsp;â€¢ <strong>Column B:</strong> Period in <strong>YYYYMM</strong> format
              &nbsp;(e.g. <code style="background:#dde;padding:1px 6px;border-radius:3px;font-size:11px;">202301</code> = January 2023)<br>
            &nbsp;&nbsp;â€¢ <strong>Columns C onward:</strong> Data values â€” column headers must match dataset data element names
          </div>

          <div class="dz" id="dz">
            <input type="file" id="fileIn" accept=".xlsx,.xls,.csv" onchange="onFile(event)">
            <div class="dz-ico">ğŸ“Š</div>
            <div class="dz-ttl">Drop your Excel file here or click to browse</div>
            <div class="dz-sub">.xlsx &nbsp;Â·&nbsp; .xls &nbsp;Â·&nbsp; .csv</div>
            <div id="fbadge" style="display:none;justify-content:center;">
              <div class="fbadge">
                <span id="fname"></span>
                <button class="rm" onclick="clearFile(event)">Ã—</button>
              </div>
            </div>
          </div>

          <div id="sheetWrap" style="display:none;margin-top:14px;">
            <div class="fr2" style="max-width:480px;">
              <div class="fg">
                <label class="fl">Sheet</label>
                <select class="fi" id="shSel" onchange="reloadSheet()"></select>
              </div>
              <div class="fg">
                <label class="fl">Header Row #</label>
                <input type="number" class="fi" id="hRow" value="1" min="1" max="30" onchange="reloadSheet()">
              </div>
            </div>
            <div id="finfo" style="font-size:13px;color:#666;margin:8px 0;"></div>
            <div class="tw" style="max-height:170px;">
              <table class="tbl" id="rawT"></table>
            </div>
          </div>

          <div class="brow">
            <button class="btn outline" onclick="go(1)">â† Back</button>
            <button class="btn gold lg" id="s2next" onclick="doReview()" disabled>Next: Review â†’</button>
          </div>
        </div>

        <!-- STEP 3: REVIEW -->
        <div class="panel" id="p3">
          <div class="sh"><span class="snum">3</span><span class="stitle">REVIEW &amp; VALIDATE</span></div>

          <div class="stats" id="rstats"></div>
          <div id="rmsg"></div>

          <div style="margin:16px 0;">
            <div style="font-weight:700;color:#004080;font-size:13px;border-bottom:2px solid #004080;padding-bottom:5px;margin-bottom:8px;">Column Headers â†’ DHIS2 Data Elements</div>
            <div class="tw"><table class="tbl"><thead><tr><th>Excel Column Header</th><th>Matched Data Element</th><th>Status</th></tr></thead><tbody id="colTb"></tbody></table></div>
          </div>

          <div style="margin:16px 0;">
            <div style="font-weight:700;color:#004080;font-size:13px;border-bottom:2px solid #004080;padding-bottom:5px;margin-bottom:8px;">Org Unit Names â†’ DHIS2 IDs (first 30)</div>
            <div class="tw"><table class="tbl"><thead><tr><th>Excel Name (Column A)</th><th>Matched DHIS2 Org Unit</th><th>Status</th></tr></thead><tbody id="ouTb"></tbody></table></div>
          </div>

          <div style="margin:16px 0;">
            <div style="font-weight:700;color:#28a745;font-size:13px;border-bottom:2px solid #28a745;padding-bottom:5px;margin-bottom:8px;">Data Preview â€” first 15 rows</div>
            <div class="tw"><table class="tbl" id="prevT"></table></div>
          </div>

          <div class="brow">
            <button class="btn outline" onclick="go(2)">â† Back</button>
            <button class="btn gold lg" id="s3next" onclick="go(4)" disabled>Next: Push to DHIS2 â†’</button>
          </div>
        </div>

        <!-- STEP 4: PUSH -->
        <div class="panel" id="p4">
          <div class="sh"><span class="snum">4</span><span class="stitle">PUSH DATA TO DHIS2</span></div>

          <div class="fr2" style="max-width:650px;margin-bottom:16px;">
            <div class="fg">
              <label class="fl">Import Strategy</label>
              <select class="fi" id="stratSel">
                <option value="CREATE_AND_UPDATE">CREATE_AND_UPDATE (Recommended)</option>
                <option value="CREATE">CREATE only</option>
                <option value="UPDATE">UPDATE only</option>
              </select>
            </div>
            <div class="fg">
              <label class="fl">Batch Size</label>
              <select class="fi" id="batchSel">
                <option value="100">100 rows</option>
                <option value="250" selected>250 rows</option>
                <option value="500">500 rows</option>
                <option value="1000">1000 rows</option>
              </select>
            </div>
          </div>

          <div class="tog"><input type="checkbox" id="dryRun"><label for="dryRun">ğŸ§ª Dry Run â€” validate without saving to DHIS2</label></div>
          <div class="tog"><input type="checkbox" id="skipAudit"><label for="skipAudit">âš¡ Skip Audit Log (faster)</label></div>

          <div class="stats" id="pstats" style="margin-top:16px;"></div>

          <div class="prg" id="prgWrap">
            <div class="prg-top">
              <strong style="color:#004080;font-size:13px;">Upload Progress</strong>
              <span id="plbl" style="font-size:12px;color:#666;"></span>
            </div>
            <div class="prg-bar"><div class="prg-fill" id="pbar" style="width:0%">0%</div></div>
            <div class="log" id="logDiv"></div>
          </div>

          <div id="presult" style="display:none;margin-top:14px;"></div>

          <div class="brow" style="justify-content:center;">
            <button class="btn outline" onclick="go(3)">â† Back</button>
            <button class="btn green lg" id="pushBtn" onclick="doPush()">ğŸš€ UPLOAD TO DHIS2</button>
            <button class="btn danger" onclick="resetAll()">Reset All</button>
          </div>
        </div>

      </div><!-- /ci -->
    </div><!-- /card -->

    <div class="footer">
      <p style="font-weight:700;">Informatics Consultancy Firm-Sierra Leone (ICF-SL)</p>
      <p>Driving Data-Driven Solutions for Health and Development</p>
      <p style="font-size:10px;">Â© 2025 ICF-SL. All rights reserved.</p>
    </div>
  </div>
</div>

<div class="ntf" id="ntf"></div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  PASTE YOUR GAS WEB APP URL BELOW AFTER DEPLOY   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROXY = 'PASTE_YOUR_GAS_URL_HERE';

// â”€â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var BASE = '', AU = '';
var allDS=[], allLvl=[], allOU=[], defCoc='';
var selDS=null, selLvl=null;
var wb=null, hdrs=[], rows=[];
var colMap=[], ouMap={}, dv=[];

// â”€â”€â”€ proxy GET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fetches DHIS2 data through the GAS proxy.
async function pGet(path) {
  const url = PROXY
    + '?url='  + encodeURIComponent(BASE + path)
    + '&auth=' + encodeURIComponent(AU);
  const res = await fetch(url);
  const txt = await res.text();
  if (!txt.trim()) throw new Error('Empty response from proxy (GET)');
  if (txt.trim()[0] === '<') throw new Error(
    'Proxy returned an HTML page instead of JSON.\n' +
    'Check your GAS URL and that the Web App is deployed with:\n' +
    '  Execute as: Me\n  Who has access: Anyone'
  );
  const j = JSON.parse(txt);
  if (j.success === false || j.message && !j.dataSets && !j.organisationUnits && !j.categoryOptionCombos && !j.organisationUnitLevels && !j.id) {
    // Only treat as error if it looks like an error response
    if (j.success === false) throw new Error(j.message || 'GET failed');
  }
  return j;
}

// â”€â”€â”€ proxy POST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Uploads data to DHIS2 through the GAS proxy.
// CRITICAL: sends as URLSearchParams (form-encoded) to avoid
// the GAS cross-origin POST â†’ 302 redirect bug.
// GAS reads the JSON from e.parameter.data in doPost().
async function pPost(path, payload) {
  const envelope = { url: BASE + path, auth: AU, payload: payload };
  // URLSearchParams automatically sets Content-Type: application/x-www-form-urlencoded
  const body = new URLSearchParams({ data: JSON.stringify(envelope) });
  const res  = await fetch(PROXY, { method: 'POST', body: body });
  const txt  = await res.text();
  if (!txt.trim()) throw new Error('Empty response from proxy (POST)');
  if (txt.trim()[0] === '<') throw new Error(
    'Proxy POST returned HTML page.\n' +
    'Re-deploy the GAS and make sure doPost() is present in Code.gs.'
  );
  const j = JSON.parse(txt);
  if (j.success === false) throw new Error(j.message || 'POST failed');
  return j;
}

// â”€â”€â”€ utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function notify(msg, t) {
  const n = document.getElementById('ntf');
  n.textContent = msg; n.className = 'ntf ' + (t||'i');
  clearTimeout(n._t); n._t = setTimeout(() => n.className='ntf', 5500);
}
function L(msg, t) {
  const b = document.getElementById('logDiv');
  const d = document.createElement('div');
  d.className = 'll ' + (t||'i');
  d.textContent = '[' + new Date().toLocaleTimeString() + ']  ' + msg;
  b.appendChild(d); b.scrollTop = b.scrollHeight;
}
function clrLog() { document.getElementById('logDiv').innerHTML = ''; }
function setP(p) {
  document.getElementById('pbar').style.width = p + '%';
  document.getElementById('pbar').textContent = p + '%';
  document.getElementById('plbl').textContent  = p + '% complete';
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function H(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function nrm(s) { return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

// Period â€” accept YYYYMM, also handle YYYY-MM just in case
function parsePer(v) {
  v = String(v||'').trim();
  if (/^\d{6}$/.test(v))        return v;                      // 202301
  const m = v.match(/^(\d{4})-(\d{2})$/);
  if (m)                         return m[1]+m[2];             // 2023-01
  if (/^\d{4}$/.test(v))        return v;                      // 2023
  if (/^\d{4}Q[1-4]$/i.test(v)) return v.toUpperCase();       // 2023Q1
  return null;
}

// â”€â”€â”€ navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function go(n) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
  document.getElementById('p'+n).classList.add('on');
  document.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.remove('on','done');
    if (i+1===n) t.classList.add('on');
    else if (i+1<n) t.classList.add('done');
  });
}

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  if (!PROXY || PROXY === 'PASTE_YOUR_GAS_URL_HERE') {
    alert(
      'You need to set your Google Apps Script URL.\n\n' +
      'Open dhis2-upload.html in any text editor.\n' +
      'Find this line near the top of the <script> section:\n\n' +
      "  const PROXY = 'PASTE_YOUR_GAS_URL_HERE';\n\n" +
      'Replace with your GAS Web App URL and save the file.'
    );
    return;
  }
  BASE = document.getElementById('iUrl').value.trim().replace(/\/+$/,'');
  AU   = 'Basic ' + btoa(document.getElementById('iUser').value.trim() + ':' + document.getElementById('iPass').value);
  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Connecting...';
  try {
    const me = await pGet('/api/me');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainDiv').classList.add('show');
    notify('Connected! Welcome ' + (me.firstName||'') + ' ' + (me.surname||''), 's');
  } catch(err) {
    notify('Connection failed: ' + err.message, 'e');
  } finally { btn.disabled=false; btn.textContent='ğŸ”— Connect to DHIS2'; }
});

// â”€â”€â”€ STEP 1: METADATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMeta() {
  const btn=document.getElementById('metaBtn'), msg=document.getElementById('metaMsg');
  btn.disabled=true; btn.textContent='â³ Loading...'; msg.textContent='';
  try {
    notify('Loading DHIS2 metadata...','i');
    const [dsR,lvR,cocR] = await Promise.all([
      pGet('/api/dataSets.json?fields=id,displayName,name,periodType,dataSetElements[dataElement[id,displayName,name]]&paging=false'),
      pGet('/api/organisationUnitLevels.json?fields=id,level,displayName&paging=false&order=level:asc'),
      pGet('/api/categoryOptionCombos.json?fields=id,displayName,name&paging=false')
    ]);
    allDS  = dsR.dataSets || [];
    allLvl = lvR.organisationUnitLevels || [];
    const cocs = cocR.categoryOptionCombos || [];
    const def  = cocs.find(c => /default/i.test(c.displayName||c.name)) || cocs[0];
    defCoc = def ? def.id : '';

    document.getElementById('dsSel').innerHTML =
      '<option value="">-- Select a dataset --</option>' +
      allDS.map(d => `<option value="${d.id}">${H(d.displayName||d.name)}</option>`).join('');
    document.getElementById('lvlSel').innerHTML =
      '<option value="">-- Select a level --</option>' +
      allLvl.map(l => `<option value="${l.level}">${H(l.displayName)} (Level ${l.level})</option>`).join('');

    msg.innerHTML = `<span style="color:#28a745;font-weight:700;">âœ“ ${allDS.length} datasets Â· ${allLvl.length} levels Â· ${cocs.length} category option combos</span>`;
    notify('Metadata loaded','s');
  } catch(err) {
    msg.innerHTML = `<span style="color:#dc3545;">âœ— ${H(err.message)}</span>`;
    notify('Failed: '+err.message,'e');
  } finally { btn.disabled=false; btn.textContent='ğŸ”„ Load Datasets & Org Unit Levels'; }
}

function onDs() {
  const id = document.getElementById('dsSel').value;
  selDS = id ? allDS.find(d=>d.id===id) : null;
  const hint = document.getElementById('dsHint');
  if (selDS) {
    const des = (selDS.dataSetElements||[]).map(e=>e.dataElement);
    hint.style.display = 'block';
    hint.innerHTML = `<strong>${des.length} data elements</strong> Â· Period type: ${selDS.periodType||'N/A'}`;
  } else { hint.style.display='none'; }
  chk1();
}

function onLvl() {
  const v = document.getElementById('lvlSel').value;
  selLvl = v ? allLvl.find(l=>l.level==parseInt(v)) : null;
  document.getElementById('ouRow').style.display = selLvl ? 'flex' : 'none';
  allOU=[]; document.getElementById('ouMsg').textContent='';
  chk1();
}

async function loadOUs() {
  if (!selLvl) return;
  const btn=document.getElementById('ouBtn'), msg=document.getElementById('ouMsg');
  btn.disabled=true; btn.textContent='â³ Loading...';
  try {
    const d = await pGet(`/api/organisationUnits.json?fields=id,displayName,name&level=${selLvl.level}&paging=false`);
    allOU = d.organisationUnits || [];
    msg.innerHTML = `<span style="color:#28a745;font-weight:700;">âœ“ ${allOU.length} org units at Level ${selLvl.level}</span>`;
    notify('Loaded '+allOU.length+' org units','s');
    chk1();
  } catch(err) {
    msg.innerHTML = `<span style="color:#dc3545;">âœ— ${H(err.message)}</span>`;
    notify('Failed: '+err.message,'e');
  } finally { btn.disabled=false; btn.textContent='ğŸ“ Load Org Units at Selected Level'; }
}

function chk1() {
  document.getElementById('s1next').disabled = !(selDS && selLvl && allOU.length>0);
}

// â”€â”€â”€ STEP 2: FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dzEl=document.getElementById('dz');
dzEl.addEventListener('dragover', e=>{e.preventDefault();dzEl.classList.add('over');});
dzEl.addEventListener('dragleave',()=>dzEl.classList.remove('over'));
dzEl.addEventListener('drop',e=>{e.preventDefault();dzEl.classList.remove('over');if(e.dataTransfer.files[0])readFile(e.dataTransfer.files[0]);});
function onFile(e){if(e.target.files[0])readFile(e.target.files[0]);}

function clearFile(e) {
  e.stopPropagation();
  wb=null;hdrs=[];rows=[];
  document.getElementById('fbadge').style.display='none';
  document.getElementById('sheetWrap').style.display='none';
  document.getElementById('fileIn').value='';
  document.getElementById('s2next').disabled=true;
}

function readFile(file) {
  const rd=new FileReader();
  rd.onload=ev=>{
    try {
      wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array',cellDates:false,raw:false});
      document.getElementById('fname').textContent=file.name+'  ('+(file.size/1024).toFixed(1)+' KB)';
      document.getElementById('fbadge').style.display='flex';
      document.getElementById('shSel').innerHTML=wb.SheetNames.map((s,i)=>`<option value="${i}">${H(s)}</option>`).join('');
      document.getElementById('sheetWrap').style.display='block';
      reloadSheet();
      notify('Loaded: '+file.name,'s');
    } catch(err){notify('Read error: '+err.message,'e');}
  };
  rd.readAsArrayBuffer(file);
}

function reloadSheet() {
  if (!wb) return;
  const idx=parseInt(document.getElementById('shSel').value)||0;
  const hr =Math.max(1,parseInt(document.getElementById('hRow').value)||1);
  const sht=wb.Sheets[wb.SheetNames[idx]];
  const raw=XLSX.utils.sheet_to_json(sht,{header:1,defval:'',raw:false});
  if (raw.length<hr){notify('File has too few rows','e');return;}
  hdrs=(raw[hr-1]||[]).map(h=>String(h).trim());
  rows=raw.slice(hr).filter(r=>r.some(c=>c!==''&&c!==null&&c!==undefined));
  document.getElementById('finfo').textContent=rows.length+' data rows  Â·  '+hdrs.length+' columns';
  renderRaw();
  document.getElementById('s2next').disabled=rows.length===0||hdrs.length<3;
}

function renderRaw() {
  let h='<thead><tr><th>#</th>'+hdrs.map(c=>`<th>${H(c)}</th>`).join('')+'</tr></thead><tbody>';
  rows.slice(0,5).forEach((r,i)=>{
    h+=`<tr><td style="color:#aaa;font-size:11px;">${i+1}</td>`+
      hdrs.map((_,ci)=>{const v=(r[ci]!=null&&r[ci]!=='')?String(r[ci]):'';return`<td class="${v?'vok':'vno'}">${H(v)||'â€“'}</td>`;}).join('')+'</tr>';
  });
  document.getElementById('rawT').innerHTML=h+'</tbody>';
}

// â”€â”€â”€ STEP 3: REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function matchDE(hdr, des) {
  const h=nrm(hdr);
  let m=des.find(de=>nrm(de.displayName||de.name)===h);
  if (m) return m;
  m=des.find(de=>{const n=nrm(de.displayName||de.name);return n.includes(h)||h.includes(n);});
  return m||null;
}

function doReview() {
  if (!selDS||!allOU.length||!rows.length){notify('Complete steps 1 and 2 first','e');return;}

  const des=(selDS.dataSetElements||[]).map(e=>e.dataElement);

  // Match headers from column C onward
  colMap=[];
  for(let i=2;i<hdrs.length;i++){
    const h=hdrs[i], m=matchDE(h,des);
    colMap.push({ci:i,hdr:h,deId:m?m.id:null,deName:m?(m.displayName||m.name):null,ok:!!m});
  }

  // Build org unit lookup
  const ouLU={};
  allOU.forEach(ou=>{ ouLU[nrm(ou.displayName||ou.name)]=ou; });

  // Unique OU names from column A
  ouMap={};
  const seen={};
  rows.forEach(r=>{const v=String(r[0]||'').trim();if(v&&!seen[v]){seen[v]=true;ouMap[v]=ouLU[nrm(v)]||null;}});

  // Build data values array
  dv=[];
  const mc=colMap.filter(c=>c.ok);
  let skipped=0;
  rows.forEach(row=>{
    const ouN=String(row[0]||'').trim();
    const perR=String(row[1]||'').trim();
    const ouO=ouMap[ouN];
    const per=parsePer(perR);
    if(!ouO||!per){skipped++;return;}
    mc.forEach(c=>{
      const v=row[c.ci];
      if(v===''||v===null||v===undefined)return;
      dv.push({dataElement:c.deId,period:per,orgUnit:ouO.id,categoryOptionCombo:defCoc,value:String(v)});
    });
  });

  // Column match table
  document.getElementById('colTb').innerHTML=colMap.length===0
    ?'<tr><td colspan="3" style="color:#999;padding:12px;text-align:center;">No data columns â€” need at least 3 columns</td></tr>'
    :colMap.map(c=>`<tr><td><strong>${H(c.hdr)}</strong></td><td>${c.ok?H(c.deName):'<em style="color:#aaa;">No match</em>'}</td><td><span class="bk ${c.ok?'ok':'skip'}">${c.ok?'MATCHED âœ“':'SKIPPED'}</span></td></tr>`).join('');

  // OU match table
  const ouE=Object.entries(ouMap).slice(0,30);
  document.getElementById('ouTb').innerHTML=ouE.length===0
    ?'<tr><td colspan="3" style="color:#999;padding:12px;text-align:center;">No org unit names found in column A</td></tr>'
    :ouE.map(([nm,m])=>`<tr><td>${H(nm)}</td><td>${m?H(m.displayName):'<em style="color:#aaa;">â€”</em>'}</td><td><span class="bk ${m?'ok':'warn'}">${m?'MATCHED âœ“':'NOT FOUND'}</span></td></tr>`).join('');

  // Stats
  const mDE=colMap.filter(c=>c.ok).length,sDE=colMap.filter(c=>!c.ok).length;
  const mOU=Object.values(ouMap).filter(Boolean).length,uOU=Object.values(ouMap).filter(v=>!v).length;
  const pers=[...new Set(dv.map(v=>v.period))];
  document.getElementById('rstats').innerHTML=
    `<div class="st blue"><div class="sv">${dv.length}</div><div class="sk">Values Ready</div></div>`+
    `<div class="st ${mDE>0?'green':'red'}"><div class="sv">${mDE}</div><div class="sk">DE Cols Matched</div></div>`+
    `<div class="st ${sDE>0?'gold':'green'}"><div class="sv">${sDE}</div><div class="sk">DE Cols Skipped</div></div>`+
    `<div class="st ${mOU>0?'green':'red'}"><div class="sv">${mOU}</div><div class="sk">OUs Matched</div></div>`+
    `<div class="st ${uOU>0?'red':'green'}"><div class="sv">${uOU}</div><div class="sk">OUs Not Found</div></div>`+
    `<div class="st"><div class="sv">${pers.length}</div><div class="sk">Periods</div></div>`+
    `<div class="st ${skipped>0?'gold':''}"><div class="sv">${skipped}</div><div class="sk">Rows Skipped</div></div>`;

  // Message
  const mEl=document.getElementById('rmsg');
  if(dv.length===0){
    mEl.innerHTML='<div class="ib red"><strong>â›” No uploadable values found.</strong><br>Check: (1) Column A org unit names match DHIS2 exactly at the selected level. (2) Column B periods are YYYYMM (e.g. 202301). (3) Column C+ headers match dataset data element names.</div>';
  }else if(uOU>0||sDE>0){
    mEl.innerHTML=`<div class="ib yellow"><strong>âš  Partial match.</strong> ${uOU} org unit(s) not found, ${sDE} column(s) skipped. Only matched data will upload.</div>`;
  }else{
    mEl.innerHTML=`<div class="ib green"><strong>âœ… Full match.</strong> ${dv.length} values ready to upload to DHIS2.</div>`;
  }

  // Preview
  const dc=colMap.filter(c=>c.ok);
  let ph=`<thead><tr><th>#</th><th>Org Unit</th><th>Period</th>${dc.map(c=>`<th>${H(c.deName)}</th>`).join('')}</tr></thead><tbody>`;
  rows.slice(0,15).forEach((row,i)=>{
    const ouN=String(row[0]||'').trim(),perR=String(row[1]||'').trim();
    const ouO=ouMap[ouN],per=parsePer(perR);
    ph+=`<tr><td style="color:#aaa;font-size:11px;">${i+1}</td>`+
      `<td class="${ouO?'vok':'vno'}">${ouO?H(ouO.displayName):'âœ— '+H(ouN)}</td>`+
      `<td class="${per?'vok':'vno'}">${per||H(perR)}</td>`+
      dc.map(c=>{const v=row[c.ci];const s=(v!==''&&v!==null&&v!==undefined)?H(String(v)):'';return`<td class="${s?'vok':'vno'}">${s||'â€“'}</td>`;}).join('')+
      '</tr>';
  });
  document.getElementById('prevT').innerHTML=ph+'</tbody>';
  document.getElementById('s3next').disabled=dv.length===0;
  go(3);
  notify(dv.length>0?`Review ready: ${dv.length} values`:'No matching values found',dv.length>0?'s':'e');
}

// â”€â”€â”€ STEP 4: PUSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doPush() {
  if (!dv.length){notify('Nothing to upload','e');return;}
  const btn=document.getElementById('pushBtn');
  btn.disabled=true;btn.textContent='â³ Uploading...';
  document.getElementById('prgWrap').classList.add('on');
  document.getElementById('presult').style.display='none';
  clrLog();setP(0);

  const strat=document.getElementById('stratSel').value;
  const bsz  =parseInt(document.getElementById('batchSel').value);
  const dry  =document.getElementById('dryRun').checked;
  const skip =document.getElementById('skipAudit').checked;

  const batches=[];
  for(let i=0;i<dv.length;i+=bsz)batches.push(dv.slice(i,i+bsz));

  let imp=0,upd=0,ign=0,errs=0;

  L('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','i');
  L('DHIS2 BULK UPLOAD STARTING','i');
  L('Dataset  : '+(selDS.displayName||selDS.name),'i');
  L('Strategy : '+strat+(dry?' [DRY RUN â€” nothing will be saved]':''),'i');
  L('Values   : '+dv.length+' in '+batches.length+' batch(es) of '+bsz,'i');
  L('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','i');

  document.getElementById('pstats').innerHTML=
    `<div class="st blue"><div class="sv">${dv.length}</div><div class="sk">Total Values</div></div>`+
    `<div class="st"><div class="sv">${batches.length}</div><div class="sk">Batches</div></div>`+
    (dry?'<div class="st gold"><div class="sv">DRY</div><div class="sk">Dry Run</div></div>':'');

  for(let b=0;b<batches.length;b++){
    const batch=batches[b];
    setP(Math.round((b/batches.length)*90));
    L(`Batch ${b+1}/${batches.length} â†’ ${batch.length} values...`,'i');
    try{
      let qs=`/api/dataValueSets?importStrategy=${strat}&dryRun=${dry}`;
      if(skip)qs+='&skipAudit=true';
      const r=await pPost(qs,{dataValues:batch});
      const ic=r.importCount||(r.response&&r.response.importCount)||{};
      const i_=ic.imported||0,u_=ic.updated||0,g_=ic.ignored||0;
      imp+=i_;upd+=u_;ign+=g_;
      L(`Batch ${b+1} â†’ âœ“${i_} imported  â†‘${u_} updated  âœ—${g_} ignored`,g_>0?'w':'s');
      const cf=r.conflicts||(r.response&&r.response.conflicts)||[];
      cf.slice(0,3).forEach(c=>L('  â†³ '+(c.value||c.object||JSON.stringify(c)),'w'));
    }catch(err){
      L(`Batch ${b+1} FAILED: ${err.message}`,'e');
      errs+=batch.length;
    }
    if(b<batches.length-1)await sleep(250);
  }

  setP(100);
  const ok=imp+upd>0;
  L('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',ok?'s':'w');
  L((dry?'DRY RUN ':'')+'COMPLETE',ok?'s':'w');
  L(`Imported:${imp}  Updated:${upd}  Ignored:${ign}  Errors:${errs}`,ok?'s':'w');
  L('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',ok?'s':'w');

  document.getElementById('pstats').innerHTML=
    `<div class="st ${imp>0?'green':''}"><div class="sv">${imp}</div><div class="sk">Imported</div></div>`+
    `<div class="st ${upd>0?'green':''}"><div class="sv">${upd}</div><div class="sk">Updated</div></div>`+
    `<div class="st ${ign>0?'red':''}"><div class="sv">${ign}</div><div class="sk">Ignored</div></div>`+
    `<div class="st ${errs>0?'red':'green'}"><div class="sv">${errs}</div><div class="sk">Batch Errors</div></div>`;

  const re=document.getElementById('presult');
  re.style.display='block';
  re.innerHTML=`<div class="ib ${ok?'green':'yellow'}"><strong>${dry?'ğŸ§ª Dry Run Complete':(ok?'âœ… Upload Successful!':'âš  Upload Finished')}</strong><br>`+
    `${imp} imported Â· ${upd} updated${ign>0?' Â· '+ign+' ignored':''}${errs>0?' Â· '+errs+' batch errors':''}.`+
    (dry?' No data was saved (dry run mode).':'')+'</div>';

  notify(ok?'Upload complete!':'Finished with issues â€” see log',ok?'s':'w');
  btn.disabled=false;btn.textContent='ğŸš€ UPLOAD TO DHIS2';
}

// â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetAll(){
  wb=null;hdrs=[];rows=[];colMap=[];ouMap={};dv=[];
  selDS=null;selLvl=null;allOU=[];
  document.getElementById('fileIn').value='';
  document.getElementById('fbadge').style.display='none';
  document.getElementById('sheetWrap').style.display='none';
  document.getElementById('s2next').disabled=true;
  document.getElementById('s1next').disabled=true;
  document.getElementById('dsSel').value='';
  document.getElementById('lvlSel').value='';
  document.getElementById('ouRow').style.display='none';
  document.getElementById('ouMsg').textContent='';
  document.getElementById('dsHint').style.display='none';
  document.getElementById('prgWrap').classList.remove('on');
  document.getElementById('presult').style.display='none';
  document.getElementById('pstats').innerHTML='';
  document.getElementById('rstats').innerHTML='';
  document.getElementById('rmsg').innerHTML='';
  go(1);
  notify('Reset complete','i');
}
</script>
</body>
</html>
